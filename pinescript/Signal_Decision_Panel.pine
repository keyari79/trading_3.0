//@version=6
indicator("SIGNAL Decision Panel + Validation v1.0", overlay=true, max_bars_back=500)

// ============================================================================
// TIMESTAMP: November 13, 2025 23:45 CET
// PURPOSE: Complete Signal Validation (Stage 4) - 8 Rejection + 5 Validation
// FRAMEWORK: v1.7 with RELAXED EMA Touch and Volume rules
// ============================================================================

// ============================================================================
// INPUTS - Display & Configuration
// ============================================================================

// Table Settings
tablePos = input.string("top_right", "Panel Position", options=["top_left", "top_right", "middle_left", "middle_right", "bottom_left", "bottom_right"], group="Display")
tableTextSize = input.string("small", "Text Size", options=["tiny", "small", "normal"], group="Display")

// Direction Selection
tradeDirection = input.string("LONG", "Trade Direction", options=["LONG", "SHORT"], group="Signal Settings", tooltip="Select trade direction for signal validation")

// Rejection Candle Criteria Inputs
minWickRatio = input.float(1.5, "Min Wick:Body Ratio", minval=1.0, step=0.1, group="Rejection Criteria")
maxBodyPercent = input.float(40.0, "Max Body % of Range", minval=0, maxval=100, step=5, group="Rejection Criteria")
minBodyPosition = input.float(40.0, "Min Body Position %", minval=0, maxval=100, step=5, group="Rejection Criteria", tooltip="For LONG: body in upper 40%. For SHORT: body in lower 40%")
minVolumeRatio = input.float(1.2, "Min Volume Ratio (RELAXED)", minval=1.0, step=0.1, group="Rejection Criteria", tooltip="Framework v1.7: Lowered from 1.5 to 1.2")

// Validation Criteria Inputs
timeBufferMinutes = input.int(30, "Time Buffer (minutes)", minval=0, group="Validation", tooltip="Minutes before session close to stop entries")
maxSpreadPips = input.float(3.0, "Max Spread (pips)", minval=0, step=0.5, group="Validation")

// Session Settings
europeOpen = input.int(8, "Europe Open (UTC)", minval=0, maxval=23, group="Sessions")
europeClose = input.int(17, "Europe Close (UTC)", minval=0, maxval=23, group="Sessions")
usOpen = input.int(13, "US Open (UTC)", minval=0, maxval=23, group="Sessions")
usClose = input.int(21, "US Close (UTC)", minval=0, maxval=23, group="Sessions")
japanOpen = input.int(0, "Japan Open (UTC)", minval=0, maxval=23, group="Sessions")
japanClose = input.int(9, "Japan Close (UTC)", minval=0, maxval=23, group="Sessions")

// Alert Settings
enableAlerts = input.bool(true, "Enable Alerts", group="Alerts")

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

getTextSize(size) =>
    size == "tiny" ? size.tiny : size == "small" ? size.small : size.normal

f_getTablePosition(pos) =>
    pos == "top_left" ? position.top_left : pos == "top_right" ? position.top_right : pos == "middle_left" ? position.middle_left : pos == "middle_right" ? position.middle_right : pos == "bottom_left" ? position.bottom_left : position.bottom_right

// ============================================================================
// SESSION TRACKING
// ============================================================================

currentHour = hour(time, "UTC")
currentMinute = minute(time, "UTC")

// Session Detection
isEurope = (currentHour >= europeOpen and currentHour < europeClose)
isUS = (currentHour >= usOpen and currentHour < usClose)
isJapan = (currentHour >= japanOpen and currentHour < japanClose) or (japanClose < japanOpen and (currentHour >= japanOpen or currentHour < japanClose))

// Active Session Label
activeSession = isEurope and isUS ? "OVERLAP" : isEurope ? "EUROPE" : isUS ? "US" : isJapan ? "JAPAN" : "None"

// ============================================================================
// EMA CALCULATIONS
// ============================================================================

ema8 = ta.ema(close, 8)
ema21 = ta.ema(close, 21)
ema55 = ta.ema(close, 55)

// Plot EMAs
plot(ema8, "EMA 8", color=color.new(#00D9FF, 0), linewidth=2)
plot(ema21, "EMA 21", color=color.new(#FF6B35, 0), linewidth=2)
plot(ema55, "EMA 55", color=color.new(#9D4EDD, 0), linewidth=2)

// ============================================================================
// REJECTION CANDLE CRITERIA (8 Checks)
// ============================================================================

// Candle Measurements
candleRange = high - low
candleBody = math.abs(close - open)
upperWick = high - math.max(open, close)
lowerWick = math.min(open, close) - low

// 1. Wick-to-Body Ratio
dominantWick = tradeDirection == "LONG" ? lowerWick : upperWick
wickBodyRatio = candleBody > 0 ? dominantWick / candleBody : 0
check1_wickRatio = wickBodyRatio >= minWickRatio

// 2. Dominant Wick Direction
check2_dominantWick = tradeDirection == "LONG" ? lowerWick > upperWick : upperWick > lowerWick

// 3. Small Body Size
bodyPercent = candleRange > 0 ? (candleBody / candleRange) * 100 : 0
check3_bodySize = bodyPercent <= maxBodyPercent

// 4. Body Position
bodyPosition = candleRange > 0 ? ((math.min(open, close) - low) / candleRange) * 100 : 0
check4_bodyPosition = tradeDirection == "LONG" ? bodyPosition >= minBodyPosition : bodyPosition <= (100 - minBodyPosition)

// 5. EMA Touch/Pierce (RELAXED - Framework v1.7)
// LONG: Low touches EMA8, EMA21, or anywhere between them
// SHORT: High touches EMA8, EMA21, or anywhere between them
ema8Val = ema8
ema21Val = ema21
emaLower = math.min(ema8Val, ema21Val)
emaUpper = math.max(ema8Val, ema21Val)

emaTouch = false
emaPierce = false

if tradeDirection == "LONG"
    // Check if low touches/pierces EMA8, EMA21, or is in between
    touchesEMA8 = low <= ema8Val and close >= ema8Val
    touchesEMA21 = low <= ema21Val and close >= ema21Val
    inEMAZone = low >= emaLower and low <= emaUpper
    piercesAndRecovers = low < emaLower and close > emaLower
    emaTouch := touchesEMA8 or touchesEMA21 or inEMAZone
    emaPierce := piercesAndRecovers
else
    // SHORT: High touches/pierces EMA8, EMA21, or is in between
    touchesEMA8 = high >= ema8Val and close <= ema8Val
    touchesEMA21 = high >= ema21Val and close <= ema21Val
    inEMAZone = high <= emaUpper and high >= emaLower
    piercesAndRecovers = high > emaUpper and close < emaUpper
    emaTouch := touchesEMA8 or touchesEMA21 or inEMAZone
    emaPierce := piercesAndRecovers

check5_emaTouch = emaTouch or emaPierce

// 6. Structure Reclaim
recentSwing = tradeDirection == "LONG" ? ta.lowest(low, 5)[1] : ta.highest(high, 5)[1]
structureReclaim = tradeDirection == "LONG" ? close > recentSwing : close < recentSwing
check6_structureReclaim = structureReclaim

// 7. Close Position
closePosition = candleRange > 0 ? ((close - low) / candleRange) * 100 : 0
check7_closePosition = tradeDirection == "LONG" ? closePosition >= 50 : closePosition <= 50

// 8. Volume Spike (RELAXED - Framework v1.7)
volumeAvg = ta.sma(volume, 20)
volumeRatio = volume / volumeAvg
check8_volumeSpike = volumeRatio >= minVolumeRatio

// Combined Rejection Candle Score
rejectionScore = (check1_wickRatio ? 1 : 0) + (check2_dominantWick ? 1 : 0) + (check3_bodySize ? 1 : 0) + (check4_bodyPosition ? 1 : 0) + (check5_emaTouch ? 1 : 0) + (check6_structureReclaim ? 1 : 0) + (check7_closePosition ? 1 : 0) + (check8_volumeSpike ? 1 : 0)

rejectionQuality = rejectionScore == 8 ? "VALID (8/8)" : rejectionScore == 7 ? "MARGINAL (7/8)" : "INVALID (" + str.tostring(rejectionScore) + "/8)"

// ============================================================================
// VALIDATION CHECKS (5 Checks)
// ============================================================================

// 1. Setup Still Valid (Placeholder - requires 15min data)
// In real implementation, this would check if 7/7 setup from 15min chart is still active
setupStillValid = true  // Assume valid for now
validCheck1 = setupStillValid

// 2. Time Quality
minutesToClose = 999
if activeSession == "EUROPE"
    minutesToClose := (europeClose - currentHour) * 60 - currentMinute
else if activeSession == "US"
    minutesToClose := (usClose - currentHour) * 60 - currentMinute
else if activeSession == "OVERLAP"
    minutesToCloseEU = (europeClose - currentHour) * 60 - currentMinute
    minutesToCloseUS = (usClose - currentHour) * 60 - currentMinute
    minutesToClose := math.min(minutesToCloseEU, minutesToCloseUS)

timeQuality = minutesToClose > timeBufferMinutes ? "GOOD" : minutesToClose > 0 ? "MODERATE" : "POOR"
validCheck2 = minutesToClose > timeBufferMinutes

// 3. No News Events (Placeholder - requires external news data)
noNewsEvents = true  // Assume no news for now
validCheck3 = noNewsEvents

// 4. Spread Acceptable (Placeholder - requires spread data)
currentSpread = 2.0  // Placeholder value
spreadAcceptable = currentSpread <= maxSpreadPips
validCheck4 = spreadAcceptable

// 5. Volume Quality
volumeQuality = volumeRatio >= 1.5 ? "GOOD" : volumeRatio >= 1.2 ? "MODERATE" : "WEAK"
validCheck5 = volumeQuality == "GOOD" or volumeQuality == "MODERATE"

// Combined Validation Score
validationScore = (validCheck1 ? 1 : 0) + (validCheck2 ? 1 : 0) + (validCheck3 ? 1 : 0) + (validCheck4 ? 1 : 0) + (validCheck5 ? 1 : 0)

validationQuality = validationScore == 5 ? "VALID (5/5)" : validationScore >= 4 ? "MARGINAL (4/5)" : "INVALID (" + str.tostring(validationScore) + "/5)"

// ============================================================================
// FINAL SIGNAL DECISION
// ============================================================================

signalExecute = rejectionScore == 8 and validationScore == 5
signalWait = rejectionScore >= 7 and validationScore >= 4 and not signalExecute
signalInvalid = not signalExecute and not signalWait

signalStatus = signalExecute ? "EXECUTE" : signalWait ? "WAIT" : "INVALID"

// ============================================================================
// DISPLAY - UNIFIED PANEL
// ============================================================================

var table mainPanel = table.new(f_getTablePosition(tablePos), 3, 23, bgcolor=color.new(#000000, 10), frame_color=color.new(#404040, 0), frame_width=2, border_width=1, border_color=color.new(#303030, 0))

if barstate.islast
    txtSize = getTextSize(tableTextSize)
    
    // === HEADER ===
    headerColor = signalExecute ? color.new(#00FF00, 0) : signalWait ? color.new(#FFA500, 0) : color.new(#FF3333, 0)
    table.cell(mainPanel, 0, 0, "SIGNAL DECISION PANEL v1.0", text_color=headerColor, bgcolor=color.new(#1A1A1A, 0), text_size=size.normal, text_halign=text.align_center)
    table.merge_cells(mainPanel, 0, 0, 2, 0)
    
    // === SESSION INFO ===
    table.cell(mainPanel, 0, 1, "SESSION", text_color=color.new(#FFD700, 0), bgcolor=color.new(#2A2A2A, 0), text_size=txtSize, text_halign=text.align_center)
    table.merge_cells(mainPanel, 0, 1, 2, 1)
    
    sessionColor = activeSession == "OVERLAP" ? color.new(#00FF00, 0) : activeSession != "None" ? color.new(#00CC00, 0) : color.new(#808080, 0)
    table.cell(mainPanel, 0, 2, "Active:", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 2, activeSession, text_color=sessionColor, bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_right)
    table.merge_cells(mainPanel, 1, 2, 2, 2)
    
    table.cell(mainPanel, 0, 3, "Time Left:", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    timeLeftColor = minutesToClose > 60 ? color.new(#00FF00, 0) : minutesToClose > 30 ? color.new(#FFA500, 0) : color.new(#FF3333, 0)
    table.cell(mainPanel, 1, 3, str.tostring(minutesToClose) + " min", text_color=timeLeftColor, bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_right)
    table.merge_cells(mainPanel, 1, 3, 2, 3)
    
    // === REJECTION CRITERIA SECTION ===
    table.cell(mainPanel, 0, 4, "REJECTION CANDLE (8 CRITERIA)", text_color=color.new(#FFD700, 0), bgcolor=color.new(#2A2A2A, 0), text_size=txtSize, text_halign=text.align_center)
    table.merge_cells(mainPanel, 0, 4, 2, 4)
    
    // Direction
    table.cell(mainPanel, 0, 5, "Direction: " + tradeDirection, text_color=color.new(#FFFFFF, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.merge_cells(mainPanel, 0, 5, 2, 5)
    
    // === REJECTION CRITERIA (8 items) ===
    table.cell(mainPanel, 0, 6, "1. Wick:Body", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 6, str.tostring(wickBodyRatio, "#.##") + ":1", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 6, check1_wickRatio ? "PASS" : "FAIL", text_color=check1_wickRatio ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=check1_wickRatio ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 7, "2. Dominant Wick", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 7, tradeDirection == "LONG" ? "Lower" : "Upper", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 7, check2_dominantWick ? "PASS" : "FAIL", text_color=check2_dominantWick ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=check2_dominantWick ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 8, "3. Body Size", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 8, str.tostring(bodyPercent, "#.#") + "%", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 8, check3_bodySize ? "PASS" : "FAIL", text_color=check3_bodySize ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=check3_bodySize ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 9, "4. Body Position", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 9, str.tostring(bodyPosition, "#.#") + "%", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 9, check4_bodyPosition ? "PASS" : "FAIL", text_color=check4_bodyPosition ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=check4_bodyPosition ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 10, "5. EMA Touch", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    emaLabel = emaPierce ? "Pierce" : emaTouch ? "Zone" : "None"
    table.cell(mainPanel, 1, 10, emaLabel, text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 10, check5_emaTouch ? "PASS" : "FAIL", text_color=check5_emaTouch ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=check5_emaTouch ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 11, "6. Structure", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 11, structureReclaim ? "Reclaim" : "No", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 11, check6_structureReclaim ? "PASS" : "FAIL", text_color=check6_structureReclaim ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=check6_structureReclaim ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 12, "7. Close Pos", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 12, str.tostring(closePosition, "#.#") + "%", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 12, check7_closePosition ? "PASS" : "FAIL", text_color=check7_closePosition ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=check7_closePosition ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 13, "8. Volume", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 13, str.tostring(volumeRatio, "#.##") + "x", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 13, check8_volumeSpike ? "PASS" : "FAIL", text_color=check8_volumeSpike ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=check8_volumeSpike ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    // Rejection Score Summary
    rejectionBgColor = rejectionScore == 8 ? color.new(#00FF00, 70) : rejectionScore == 7 ? color.new(#FFA500, 70) : color.new(#FF3333, 70)
    table.cell(mainPanel, 0, 14, rejectionQuality, text_color=headerColor, bgcolor=rejectionBgColor, text_size=txtSize, text_halign=text.align_center)
    table.merge_cells(mainPanel, 0, 14, 2, 14)
    
    // === VALIDATION CHECKS SECTION ===
    table.cell(mainPanel, 0, 15, "VALIDATION CHECKS (5)", text_color=color.new(#FFD700, 0), bgcolor=color.new(#2A2A2A, 0), text_size=txtSize, text_halign=text.align_center)
    table.merge_cells(mainPanel, 0, 15, 2, 15)
    
    // Validation Checks
    table.cell(mainPanel, 0, 16, "1. Setup Valid", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 16, setupStillValid ? "7/7" : "No", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 16, validCheck1 ? "PASS" : "FAIL", text_color=validCheck1 ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=validCheck1 ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 17, "2. Time Quality", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 17, timeQuality, text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 17, validCheck2 ? "PASS" : "FAIL", text_color=validCheck2 ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=validCheck2 ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 18, "3. News Check", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 18, noNewsEvents ? "Clear" : "Event", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 18, validCheck3 ? "PASS" : "FAIL", text_color=validCheck3 ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=validCheck3 ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 19, "4. Spread", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 19, str.tostring(currentSpread, "#.#") + "p", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 19, validCheck4 ? "PASS" : "FAIL", text_color=validCheck4 ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=validCheck4 ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    table.cell(mainPanel, 0, 20, "5. Vol Quality", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(mainPanel, 1, 20, volumeQuality, text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.cell(mainPanel, 2, 20, validCheck5 ? "PASS" : "FAIL", text_color=validCheck5 ? color.new(#00FF00, 0) : color.new(#FF3333, 0), bgcolor=validCheck5 ? color.new(#00FF00, 85) : color.new(#FF3333, 85), text_size=txtSize, text_halign=text.align_center)
    
    // Validation Score Summary
    validationBgColor = validationScore == 5 ? color.new(#00FF00, 70) : validationScore >= 4 ? color.new(#FFA500, 70) : color.new(#FF3333, 70)
    validationColor = validationScore == 5 ? color.new(#00FF00, 0) : validationScore >= 4 ? color.new(#FFA500, 0) : color.new(#FF3333, 0)
    table.cell(mainPanel, 0, 21, validationQuality, text_color=validationColor, bgcolor=validationBgColor, text_size=txtSize, text_halign=text.align_center)
    table.merge_cells(mainPanel, 0, 21, 2, 21)
    
    // === FINAL STATUS ===
    statusBgColor = signalExecute ? color.new(#00FF00, 60) : signalWait ? color.new(#FFA500, 60) : color.new(#FF3333, 60)
    statusTextSize = signalExecute ? size.large : size.normal
    table.cell(mainPanel, 0, 22, signalStatus, text_color=headerColor, bgcolor=statusBgColor, text_size=statusTextSize, text_halign=text.align_center)
    table.merge_cells(mainPanel, 0, 22, 2, 22)

// ============================================================================
// ALERTS
// ============================================================================

if enableAlerts and signalExecute and not signalExecute[1]
    alert("EXECUTE SIGNAL: " + tradeDirection + " - All 8 rejection + 5 validation criteria met!", alert.freq_once_per_bar)

if enableAlerts and signalWait and not signalWait[1]
    alert("WAIT SIGNAL: " + tradeDirection + " - Marginal quality (7/8 + 4/5). Monitor next candle.", alert.freq_once_per_bar)

alertcondition(signalExecute, title="EXECUTE Signal", message="EXECUTE: Valid signal detected - Enter now!")
alertcondition(signalWait, title="WAIT Signal", message="WAIT: Marginal signal - Monitor next candle")

// ============================================================================
// VISUAL MARKERS
// ============================================================================

// Plot signals on chart
plotshape(signalExecute, style=shape.triangleup, location=location.belowbar, color=color.new(#00FF00, 0), size=size.tiny, title="EXECUTE Signal")
plotshape(signalWait, style=shape.circle, location=location.belowbar, color=color.new(#FFA500, 0), size=size.tiny, title="WAIT Signal")

// Highlight rejection candle
barcolor(signalExecute ? color.new(#00FF00, 70) : signalWait ? color.new(#FFA500, 80) : na)