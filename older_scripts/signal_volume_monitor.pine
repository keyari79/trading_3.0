//@version=6
indicator("SIGNAL Volume Monitor", overlay=false, max_bars_back=500)

// ============================================================================
// INPUTS - Display & Configuration
// ============================================================================

// Table Settings
tablePos = input.string("top_right", "Panel Position", options=["top_left", "top_right", "middle_left", "middle_right", "bottom_left", "bottom_right"], group="Display")
tableTextSize = input.string("small", "Text Size", options=["tiny", "small", "normal"], group="Display")
showVolumeBars = input.bool(true, "Show Volume Bars", group="Display")
showThresholdLines = input.bool(true, "Show Threshold Lines", group="Display")

// Volume Settings
volumeAvgLength = input.int(20, "Volume Average Length", minval=1, group="Volume Settings", tooltip="SMA period for volume comparison")
thresholdWeak = input.float(1.2, "Weak/Moderate Threshold", minval=1.0, step=0.1, group="Volume Settings")
thresholdGood = input.float(1.5, "Good Threshold", minval=1.0, step=0.1, group="Volume Settings")
thresholdStrong = input.float(2.0, "Strong Threshold", minval=1.0, step=0.1, group="Volume Settings")

// Alert Settings
enableAlerts = input.bool(true, "Enable Alerts", group="Alerts")

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

getTextSize(size) =>
    size == "tiny" ? size.tiny : size == "small" ? size.small : size.normal

f_getTablePosition(pos) =>
    pos == "top_left" ? position.top_left : pos == "top_right" ? position.top_right : pos == "middle_left" ? position.middle_left : pos == "middle_right" ? position.middle_right : pos == "bottom_left" ? position.bottom_left : position.bottom_right

// ============================================================================
// VOLUME CALCULATIONS
// ============================================================================

// Volume Average
volumeAvg = ta.sma(volume, volumeAvgLength)

// Volume Ratio
volumeRatio = volume / volumeAvg

// Quality Tier Classification
volumeQuality = volumeRatio >= thresholdStrong ? "STRONG" : volumeRatio >= thresholdGood ? "GOOD" : volumeRatio >= thresholdWeak ? "MODERATE" : "WEAK"

// Color Assignment
volumeColor = volumeRatio >= thresholdStrong ? color.new(#00FF00, 0) : volumeRatio >= thresholdGood ? color.new(#00CC00, 0) : volumeRatio >= thresholdWeak ? color.new(#FFA500, 0) : color.new(#FF3333, 0)

// Background color for quality
qualityBgColor = volumeRatio >= thresholdStrong ? color.new(#00FF00, 85) : volumeRatio >= thresholdGood ? color.new(#00CC00, 85) : volumeRatio >= thresholdWeak ? color.new(#FFA500, 85) : color.new(#FF3333, 85)

// ============================================================================
// DISPLAY - VOLUME BARS
// ============================================================================

plot(showVolumeBars ? volumeRatio : na, "Volume Ratio", color=volumeColor, style=plot.style_histogram, linewidth=3)

// Threshold Lines
hline(showThresholdLines ? thresholdWeak : na, "Weak/Moderate", color=color.new(#FFA500, 50), linestyle=hline.style_dashed, linewidth=1)
hline(showThresholdLines ? thresholdGood : na, "Good", color=color.new(#00CC00, 50), linestyle=hline.style_dashed, linewidth=1)
hline(showThresholdLines ? thresholdStrong : na, "Strong", color=color.new(#00FF00, 50), linestyle=hline.style_dashed, linewidth=1)

// Reference line at 1.0
hline(1.0, "Average", color=color.new(#808080, 50), linestyle=hline.style_solid, linewidth=1)

// ============================================================================
// DISPLAY - VOLUME PANEL (Compact & Clean)
// ============================================================================

var table volumeTable = table.new(f_getTablePosition(tablePos), 2, 6, bgcolor=color.new(#000000, 10), frame_color=color.new(#404040, 0), frame_width=2, border_width=1, border_color=color.new(#303030, 0))

if barstate.islast
    txtSize = getTextSize(tableTextSize)
    
    // Header
    table.cell(volumeTable, 0, 0, "VOLUME MONITOR", text_color=color.new(#FFD700, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_center)
    table.merge_cells(volumeTable, 0, 0, 1, 0)
    
    // Volume Ratio - Prominent Display
    table.cell(volumeTable, 0, 1, "Volume Ratio:", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(volumeTable, 1, 1, str.tostring(volumeRatio, "#.##") + "x", text_color=volumeColor, bgcolor=color.new(#1A1A1A, 0), text_size=size.normal, text_halign=text.align_right)
    
    // Quality Tier with Background
    table.cell(volumeTable, 0, 2, "Quality:", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(volumeTable, 1, 2, volumeQuality, text_color=volumeColor, bgcolor=qualityBgColor, text_size=txtSize, text_halign=text.align_right)
    
    // Current Volume
    table.cell(volumeTable, 0, 3, "Current Vol:", text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(volumeTable, 1, 3, str.tostring(volume, format.volume), text_color=color.new(#FFFFFF, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_right)
    
    // Average Volume
    avgLabel = "Avg Vol (" + str.tostring(volumeAvgLength) + "):"
    table.cell(volumeTable, 0, 4, avgLabel, text_color=color.new(#C0C0C0, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize)
    table.cell(volumeTable, 1, 4, str.tostring(volumeAvg, format.volume), text_color=color.new(#FFFFFF, 0), bgcolor=color.new(#1A1A1A, 0), text_size=txtSize, text_halign=text.align_right)
    
    // Status Indicator
    statusText = volumeRatio >= thresholdGood ? "VALID" : volumeRatio >= thresholdWeak ? "MARGINAL" : "INSUFFICIENT"
    statusColor = volumeRatio >= thresholdGood ? color.new(#00FF00, 0) : volumeRatio >= thresholdWeak ? color.new(#FFA500, 0) : color.new(#FF3333, 0)
    statusBgColor = volumeRatio >= thresholdGood ? color.new(#00FF00, 70) : volumeRatio >= thresholdWeak ? color.new(#FFA500, 70) : color.new(#FF3333, 70)
    table.cell(volumeTable, 0, 5, statusText, text_color=statusColor, bgcolor=statusBgColor, text_size=txtSize, text_halign=text.align_center)
    table.merge_cells(volumeTable, 0, 5, 1, 5)

// ============================================================================
// ALERTS
// ============================================================================

// Alert when volume crosses above 1.2x threshold
alert12x = ta.crossover(volumeRatio, thresholdWeak)
if enableAlerts and alert12x
    alert("Volume crossed above 1.2x threshold: " + str.tostring(volumeRatio, "#.##") + "x", alert.freq_once_per_bar)

alertcondition(alert12x, title="Volume >= 1.2x", message="Volume reached 1.2x threshold")

// Alert when volume crosses above 1.5x threshold
alert15x = ta.crossover(volumeRatio, thresholdGood)
if enableAlerts and alert15x
    alert("Volume crossed above 1.5x threshold: " + str.tostring(volumeRatio, "#.##") + "x", alert.freq_once_per_bar)

alertcondition(alert15x, title="Volume >= 1.5x", message="Volume reached 1.5x threshold (GOOD)")

// Alert when volume crosses above 2.0x threshold
alert20x = ta.crossover(volumeRatio, thresholdStrong)
if enableAlerts and alert20x
    alert("STRONG volume detected: " + str.tostring(volumeRatio, "#.##") + "x", alert.freq_once_per_bar)

alertcondition(alert20x, title="Volume >= 2.0x (STRONG)", message="STRONG Volume detected")