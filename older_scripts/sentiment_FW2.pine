//@version=6
indicator("FW2 Market Sentiment + Multi-Instrument Screening", shorttitle="FW2 Sentiment", overlay=false, max_labels_count=500, max_lines_count=500, max_bars_back=5000)

// ============================================================================
// FRAMEWORK 2.0 - DUAL TABLE LAYOUT
// ============================================================================
// LEFT TABLE (middle_left): Market Sentiment (from v4.0 single table)
// RIGHT TABLE (middle_right): Multi-Instrument Screening (Stage 2)
// v5.7 UPDATES: 
// - Fixed text sizes in Correlation Conflicts section
// - Added score-based sorting to Multi-Instrument table
// - Added EUR‚ÜîSilver and Gold‚ÜîSilver plots (5 total correlation plots)
// - Added correlation legend table in indicator pane (top-right)
// ============================================================================

// ============================================================================
// SECTION 1: INPUT PARAMETERS
// ============================================================================

// --- VOLATILITY REGIME Settings ---
vr_atrLength = input.int(14, "ATR Period", minval=5, maxval=50, group="‚ö° Volatility Regime")
vr_percentileLookback = input.int(100, "Percentile Lookback", minval=20, maxval=252, group="‚ö° Volatility Regime")
vr_lowThreshold = input.float(20.0, "LOW Regime Threshold", minval=0, maxval=100, step=5, group="‚ö° Volatility Regime")
vr_highThreshold = input.float(80.0, "HIGH Regime Threshold", minval=0, maxval=100, step=5, group="‚ö° Volatility Regime")
vr_basePositionSize = input.float(100.0, "Base Position Size (EUR)", minval=10, group="‚ö° Volatility Regime")
vr_highRegimeReduction = input.float(0.5, "HIGH Regime Reduction", minval=0.1, maxval=1.0, step=0.1, group="‚ö° Volatility Regime")

// --- MARKET CONTEXT - Correlation Settings ---
mc_correlationPeriod = input.int(20, "Correlation Lookback Period", minval=5, maxval=100, group="üìä Market Context - Correlation")
mc_correlationThreshold = input.float(0.5, "Conflict Threshold", minval=0.1, maxval=1.0, step=0.05, group="üìä Market Context - Correlation")

// --- INTERMARKET Settings ---
im_showIntermarket = input.bool(true, "Show Intermarket Context", group="üåç Intermarket Analysis")
im_vixRiskOnLevel = input.float(20.0, "VIX Risk-On Level", minval=10, maxval=30, group="üåç Intermarket Analysis")
im_vixRiskOffLevel = input.float(25.0, "VIX Risk-Off Level", minval=20, maxval=40, group="üåç Intermarket Analysis")
im_extremeVixLevel = input.float(30.0, "VIX Extreme Level", minval=25, maxval=50, group="üåç Intermarket Analysis")

// --- MARKET CONTEXT - Instrument Selection ---
shared_instrument1 = input.symbol("FX:EURUSD", "Instrument 1 (EUR/USD)", group="üåê Shared Instruments")
shared_instrument2 = input.symbol("FX:USDJPY", "Instrument 2 (USD/JPY)", group="üåê Shared Instruments")
shared_instrument3 = input.symbol("FX:XAUUSD", "Instrument 3 (Gold)", group="üåê Shared Instruments")
shared_instrument4 = input.symbol("FX:XAGUSD", "Instrument 4 (Silver)", group="üåê Shared Instruments")
shared_instrument5 = input.symbol("TVC:USOIL", "Instrument 5 (Oil)", group="üåê Shared Instruments")

// --- MARKET CONTEXT - Trading Focus (uses the 5 Framework instruments) ---
mc_showConviction = input.bool(true, "Show Trading Focus", group="üìä Market Context - Focus")

// --- MARKET CONTEXT - Session Settings ---
mc_showSessionStrength = input.bool(true, "Show Session Strength", group="üìä Market Context - Session")
mc_basePositionSize = input.float(100.0, "Session Base Position (EUR)", minval=10, group="üìä Market Context - Session")

// --- SCREENING - Session Settings ---
int asiaStart = input.int(0, "Asia Session Start (UTC)", minval=0, maxval=23, group="üîç Screening Sessions")
int asiaEnd = input.int(7, "Asia Session End (UTC)", minval=0, maxval=23, group="üîç Screening Sessions")
int europeStart = input.int(7, "Europe Session Start (UTC)", minval=0, maxval=23, group="üîç Screening Sessions")
int europeEnd = input.int(16, "Europe Session End (UTC)", minval=0, maxval=23, group="üîç Screening Sessions")
int usStart = input.int(13, "US Session Start (UTC)", minval=0, maxval=23, group="üîç Screening Sessions")
int usEnd = input.int(20, "US Session End (UTC)", minval=0, maxval=23, group="üîç Screening Sessions")

// --- DISPLAY SETTINGS (applies to both tables) ---
string unifiedTableSize = input.string("small", "Table Text Size", options=["auto", "tiny", "small", "normal", "large", "huge"], group="üé® Display Settings")

// ============================================================================
// UNIFIED COLOR PALETTE (Consistent across both tables)
// ============================================================================
color COLOR_HEADER_BG = color.new(#1E4D8B, 0)
color COLOR_SECTION_HEADER_BG = color.new(#2A2A2A, 0)
color COLOR_CELL_BG_DARK = color.new(#1A1A1A, 0)
color COLOR_CELL_BG_DARKER = color.new(#0A0A0A, 0)
color COLOR_SEPARATOR = color.new(#2A2A2A, 0)
color COLOR_BORDER = color.new(#3A3A3A, 0)

color COLOR_TEXT_WHITE = color.new(color.white, 0)
color COLOR_TEXT_LIGHT = color.new(#E0E0E0, 0)
color COLOR_TEXT_MEDIUM = color.new(#CCCCCC, 0)
color COLOR_TEXT_DIM = color.new(#B0B0B0, 0)

color COLOR_GREEN = color.new(#00FF88, 0)
color COLOR_GREEN_BG = color.new(#00FF88, 30)
color COLOR_GREEN_BG_LIGHT = color.new(#00FF88, 50)
color COLOR_GREEN_BG_LIGHTER = color.new(#00FF88, 70)

color COLOR_RED = color.new(#FF4444, 0)
color COLOR_RED_BG = color.new(#FF4444, 30)
color COLOR_RED_BG_LIGHT = color.new(#FF4444, 50)
color COLOR_RED_BG_LIGHTER = color.new(#FF4444, 70)

color COLOR_YELLOW = color.new(#FFD700, 0)
color COLOR_YELLOW_BG = color.new(#FFD700, 30)
color COLOR_YELLOW_BG_LIGHT = color.new(#FFD700, 50)

color COLOR_GRAY = color.new(#666666, 0)
color COLOR_GRAY_BG = color.new(#666666, 60)
color COLOR_GRAY_BG_LIGHT = color.new(#666666, 70)
color COLOR_GRAY_BG_LIGHTER = color.new(#666666, 80)

color COLOR_BLUE_BG = color.new(color.blue, 50)
color COLOR_PURPLE_BG = color.new(color.purple, 50)

// ============================================================================
// SECTION 2: MARKET SENTIMENT CALCULATIONS
// ============================================================================

// --- INTERMARKET DATA ---
dxy = request.security("TVC:DXY", timeframe.period, close)
dxy_ma50 = request.security("TVC:DXY", timeframe.period, ta.sma(close, 50))
vix = request.security("CBOE:VIX", timeframe.period, close)
sp500 = request.security("SP:SPX", timeframe.period, close)
sp500_ma20 = request.security("SP:SPX", timeframe.period, ta.sma(close, 20))

vix_signal = vix < im_vixRiskOnLevel ? "RISK-ON" : vix > im_vixRiskOffLevel ? "RISK-OFF" : "NEUTRAL"
sp500_signal = sp500 > sp500_ma20 ? "BULLISH" : "BEARISH"
dxy_signal = dxy < dxy_ma50 ? "WEAK $" : "STRONG $"

risk_on_count = (vix < im_vixRiskOnLevel ? 1 : 0) + (sp500 > sp500_ma20 ? 1 : 0) + (dxy < dxy_ma50 ? 1 : 0)
risk_off_count = (vix > im_vixRiskOffLevel ? 1 : 0) + (sp500 < sp500_ma20 ? 1 : 0) + (dxy > dxy_ma50 ? 1 : 0)

im_environment = risk_on_count >= 2 ? "RISK-ON" : risk_off_count >= 2 ? "RISK-OFF" : "NEUTRAL"
im_env_color = im_environment == "RISK-ON" ? COLOR_GREEN_BG : im_environment == "RISK-OFF" ? COLOR_RED_BG : COLOR_GRAY_BG

im_positionAdjustment = im_environment == "RISK-OFF" ? 0.75 : vix > im_extremeVixLevel ? 0.5 : 1.0
im_adjustmentText = im_environment == "RISK-OFF" ? "Risk-Off: 75%" : vix > im_extremeVixLevel ? "EXTREME: 50%" : "Normal: 100%"

// --- VOLATILITY REGIME (CURRENT SYMBOL) ---
vr_dailyATR = request.security(syminfo.tickerid, "D", ta.atr(vr_atrLength), lookahead=barmerge.lookahead_off)
vr_atrValue = vr_dailyATR

var float[] vr_atrHistory = array.new_float(0)
if barstate.islast
    array.clear(vr_atrHistory)
    for i = 0 to math.min(vr_percentileLookback - 1, bar_index)
        historicalATR = vr_dailyATR[i]
        if not na(historicalATR)
            array.push(vr_atrHistory, historicalATR)

vr_atrPercentile = 0.0
if barstate.islast and array.size(vr_atrHistory) > 0
    sortedATR = array.copy(vr_atrHistory)
    array.sort(sortedATR, order.ascending)
    currentRank = 0
    arraySize = array.size(sortedATR)
    for i = 0 to arraySize - 1
        if array.get(sortedATR, i) <= vr_atrValue
            currentRank := i + 1
    vr_atrPercentile := (currentRank / arraySize) * 100

var string vr_currentRegime = "NORMAL"
var color vr_regimeColor = color.green

if vr_atrPercentile < vr_lowThreshold
    vr_currentRegime := "LOW"
    vr_regimeColor := COLOR_YELLOW_BG
else if vr_atrPercentile > vr_highThreshold
    vr_currentRegime := "HIGH"
    vr_regimeColor := COLOR_RED_BG
else
    vr_currentRegime := "NORMAL"
    vr_regimeColor := COLOR_GREEN_BG

vr_baseAdjustment = vr_currentRegime == "HIGH" ? vr_highRegimeReduction : 1.0
vr_positionSize = vr_basePositionSize * vr_baseAdjustment * im_positionAdjustment

vr_stopMultiplier = vr_currentRegime == "HIGH" ? 1.5 : vr_currentRegime == "LOW" ? 0.8 : 1.0
vr_targetRMultiple = vr_currentRegime == "HIGH" ? "1.5-2.0R" : vr_currentRegime == "LOW" ? "1.3R" : "1.5-2.0R"
vr_entryZone = vr_currentRegime == "HIGH" ? "¬±0.75 ATR" : "¬±0.5 ATR"

// --- MULTI-INSTRUMENT VOLATILITY ---
vr_getRegime(string ticker) =>
    instATR = request.security(ticker, "D", ta.atr(vr_atrLength), lookahead=barmerge.lookahead_off)
    var float[] instHistory = array.new_float(0)
    array.clear(instHistory)
    for i = 0 to math.min(vr_percentileLookback - 1, bar_index)
        histATR = instATR[i]
        if not na(histATR)
            array.push(instHistory, histATR)
    instPercentile = 0.0
    if array.size(instHistory) > 0
        sortedInstATR = array.copy(instHistory)
        array.sort(sortedInstATR, order.ascending)
        instRank = 0
        instSize = array.size(sortedInstATR)
        for i = 0 to instSize - 1
            if array.get(sortedInstATR, i) <= instATR
                instRank := i + 1
        instPercentile := (instRank / instSize) * 100
    regime = instPercentile < vr_lowThreshold ? "LOW" : instPercentile > vr_highThreshold ? "HIGH" : "NORMAL"
    [regime, instPercentile]

[vr_regime1, vr_percentile1] = vr_getRegime(shared_instrument1)
[vr_regime2, vr_percentile2] = vr_getRegime(shared_instrument2)
[vr_regime3, vr_percentile3] = vr_getRegime(shared_instrument3)
[vr_regime4, vr_percentile4] = vr_getRegime(shared_instrument4)
[vr_regime5, vr_percentile5] = vr_getRegime(shared_instrument5)

vr_posSize1 = (vr_regime1 == "HIGH" ? vr_basePositionSize * vr_highRegimeReduction : vr_basePositionSize) * im_positionAdjustment
vr_posSize2 = (vr_regime2 == "HIGH" ? vr_basePositionSize * vr_highRegimeReduction : vr_basePositionSize) * im_positionAdjustment
vr_posSize3 = (vr_regime3 == "HIGH" ? vr_basePositionSize * vr_highRegimeReduction : vr_basePositionSize) * im_positionAdjustment
vr_posSize4 = (vr_regime4 == "HIGH" ? vr_basePositionSize * vr_highRegimeReduction : vr_basePositionSize) * im_positionAdjustment
vr_posSize5 = (vr_regime5 == "HIGH" ? vr_basePositionSize * vr_highRegimeReduction : vr_basePositionSize) * im_positionAdjustment

// --- CORRELATIONS ---
mc_price1 = request.security(shared_instrument1, "D", close)
mc_price2 = request.security(shared_instrument2, "D", close)
mc_price3 = request.security(shared_instrument3, "D", close)
mc_price4 = request.security(shared_instrument4, "D", close)
mc_price5 = request.security(shared_instrument5, "D", close)

mc_corr_1_2 = ta.correlation(mc_price1, mc_price2, mc_correlationPeriod)
mc_corr_1_3 = ta.correlation(mc_price1, mc_price3, mc_correlationPeriod)
mc_corr_1_4 = ta.correlation(mc_price1, mc_price4, mc_correlationPeriod)
mc_corr_2_5 = ta.correlation(mc_price2, mc_price5, mc_correlationPeriod)
mc_corr_3_4 = ta.correlation(mc_price3, mc_price4, mc_correlationPeriod)

// --- TRADING FOCUS ---
mc_dailyChange() => (close - close[1]) / close[1] * 100

mc_change1 = request.security(shared_instrument1, "D", mc_dailyChange())
mc_change2 = request.security(shared_instrument2, "D", mc_dailyChange())
mc_change3 = request.security(shared_instrument3, "D", mc_dailyChange())
mc_change4 = request.security(shared_instrument4, "D", mc_dailyChange())
mc_change5 = request.security(shared_instrument5, "D", mc_dailyChange())

mc_pair1Name = str.length(shared_instrument1) >= 6 ? str.substring(shared_instrument1, str.length(shared_instrument1) - 6) : shared_instrument1
mc_pair2Name = str.length(shared_instrument2) >= 6 ? str.substring(shared_instrument2, str.length(shared_instrument2) - 6) : shared_instrument2
mc_pair3Name = str.length(shared_instrument3) >= 6 ? str.substring(shared_instrument3, str.length(shared_instrument3) - 6) : shared_instrument3
mc_pair4Name = str.length(shared_instrument4) >= 6 ? str.substring(shared_instrument4, str.length(shared_instrument4) - 6) : shared_instrument4
mc_pair5Name = str.length(shared_instrument5) >= 6 ? str.substring(shared_instrument5, str.length(shared_instrument5) - 6) : shared_instrument5

mc_maxChange = math.max(mc_change1, math.max(mc_change2, math.max(mc_change3, math.max(mc_change4, mc_change5))))
var string mc_primaryPair = ""
var float mc_primaryChange = 0.0
var string mc_secondaryPair = ""
var float mc_secondaryChange = 0.0

if mc_change1 == mc_maxChange
    mc_primaryPair := mc_pair1Name
    mc_primaryChange := mc_change1
    mc_secondaryChange := math.max(mc_change2, math.max(mc_change3, math.max(mc_change4, mc_change5)))
    if mc_change2 == mc_secondaryChange
        mc_secondaryPair := mc_pair2Name
    else if mc_change3 == mc_secondaryChange
        mc_secondaryPair := mc_pair3Name
    else if mc_change4 == mc_secondaryChange
        mc_secondaryPair := mc_pair4Name
    else
        mc_secondaryPair := mc_pair5Name
else if mc_change2 == mc_maxChange
    mc_primaryPair := mc_pair2Name
    mc_primaryChange := mc_change2
    mc_secondaryChange := math.max(mc_change1, math.max(mc_change3, math.max(mc_change4, mc_change5)))
    if mc_change1 == mc_secondaryChange
        mc_secondaryPair := mc_pair1Name
    else if mc_change3 == mc_secondaryChange
        mc_secondaryPair := mc_pair3Name
    else if mc_change4 == mc_secondaryChange
        mc_secondaryPair := mc_pair4Name
    else
        mc_secondaryPair := mc_pair5Name
else if mc_change3 == mc_maxChange
    mc_primaryPair := mc_pair3Name
    mc_primaryChange := mc_change3
    mc_secondaryChange := math.max(mc_change1, math.max(mc_change2, math.max(mc_change4, mc_change5)))
    if mc_change1 == mc_secondaryChange
        mc_secondaryPair := mc_pair1Name
    else if mc_change2 == mc_secondaryChange
        mc_secondaryPair := mc_pair2Name
    else if mc_change4 == mc_secondaryChange
        mc_secondaryPair := mc_pair4Name
    else
        mc_secondaryPair := mc_pair5Name
else if mc_change4 == mc_maxChange
    mc_primaryPair := mc_pair4Name
    mc_primaryChange := mc_change4
    mc_secondaryChange := math.max(mc_change1, math.max(mc_change2, math.max(mc_change3, mc_change5)))
    if mc_change1 == mc_secondaryChange
        mc_secondaryPair := mc_pair1Name
    else if mc_change2 == mc_secondaryChange
        mc_secondaryPair := mc_pair2Name
    else if mc_change3 == mc_secondaryChange
        mc_secondaryPair := mc_pair3Name
    else
        mc_secondaryPair := mc_pair5Name
else
    mc_primaryPair := mc_pair5Name
    mc_primaryChange := mc_change5
    mc_secondaryChange := math.max(mc_change1, math.max(mc_change2, math.max(mc_change3, mc_change4)))
    if mc_change1 == mc_secondaryChange
        mc_secondaryPair := mc_pair1Name
    else if mc_change2 == mc_secondaryChange
        mc_secondaryPair := mc_pair2Name
    else if mc_change3 == mc_secondaryChange
        mc_secondaryPair := mc_pair3Name
    else
        mc_secondaryPair := mc_pair4Name

mc_primaryBias = mc_primaryChange > 0 ? "BUY" : "SELL"
mc_secondaryBias = mc_secondaryChange > 0 ? "BUY" : "SELL"

// --- SESSION STRENGTH ---
mc_currentTimeGMT = timenow
mc_currentHour = hour(mc_currentTimeGMT, "GMT+1")
mc_currentMinute = minute(mc_currentTimeGMT, "GMT+1")
mc_currentTimeMinutes = mc_currentHour * 60 + mc_currentMinute
mc_currentDayOfWeek = dayofweek(mc_currentTimeGMT, "GMT+1")

var string mc_currentSession = "OFF-HOURS"
var string mc_sessionStrength = "WEAK"
var float mc_sessionPositionSize = 50.0

if mc_currentTimeMinutes >= 0 and mc_currentTimeMinutes < 540
    mc_currentSession := "ASIA"
else if mc_currentTimeMinutes >= 540 and mc_currentTimeMinutes < 960
    mc_currentSession := "LONDON"
else if mc_currentTimeMinutes >= 960 and mc_currentTimeMinutes < 1320
    mc_currentSession := "NY"
else
    mc_currentSession := "OFF-HOURS"

if mc_currentSession == "LONDON"
    mc_sessionStrength := "PRIME"
    mc_sessionPositionSize := mc_basePositionSize * im_positionAdjustment
else if mc_currentSession == "NY"
    mc_sessionStrength := "PRIME"
    mc_sessionPositionSize := mc_basePositionSize * im_positionAdjustment
else if mc_currentSession == "ASIA"
    mc_sessionStrength := "ACCEPTABLE"
    mc_sessionPositionSize := mc_basePositionSize * 0.75 * im_positionAdjustment
else
    mc_sessionStrength := "WEAK"
    mc_sessionPositionSize := mc_basePositionSize * 0.5 * im_positionAdjustment

mc_isWeekend = mc_currentDayOfWeek == dayofweek.saturday or mc_currentDayOfWeek == dayofweek.sunday
if mc_isWeekend
    mc_currentSession := "WEEKEND"
    mc_sessionStrength := "CLOSED"
    mc_sessionPositionSize := 0.0

// ============================================================================
// SECTION 3: SCREENING CALCULATIONS
// ============================================================================

getVolatilityRegimeScreen(float atrValue, float atrP20, float atrP80) =>
    regime = atrValue < atrP20 ? "L" : atrValue > atrP80 ? "H" : "N"
    color regimeColor = regime == "L" ? COLOR_YELLOW : regime == "H" ? COLOR_RED : COLOR_GREEN
    int score = regime == "N" ? 10 : regime == "H" ? 7 : 4
    [regime, regimeColor, score]

getSessionAlignment(string symbol) =>
    alignment = "EUR"
    if str.contains(symbol, "JPY")
        alignment := "ASIA-EUR"
    else if str.contains(symbol, "USD")
        alignment := "EUR-US"
    else if str.contains(symbol, "XAU") or str.contains(symbol, "GOLD")
        alignment := "EUR-US"
    else if str.contains(symbol, "XAG") or str.contains(symbol, "SILVER")
        alignment := "EUR-US"
    else if str.contains(symbol, "OIL") or str.contains(symbol, "CL")
        alignment := "US"
    alignment

isOptimalSession(string alignment) =>
    hour_utc = hour(time, "UTC")
    inAsia = hour_utc >= asiaStart and hour_utc < asiaEnd
    inEurope = hour_utc >= europeStart and hour_utc < europeEnd
    inUS = hour_utc >= usStart and hour_utc < usEnd
    optimal = false
    if alignment == "ASIA-EUR"
        optimal := inAsia or inEurope
    else if alignment == "EUR-US"
        optimal := inEurope or inUS
    else if alignment == "US"
        optimal := inUS
    else if alignment == "EUR"
        optimal := inEurope
    int score = optimal ? 10 : 3
    [optimal, score]

get24HChange(string symbol) =>
    [dailyClose, dailyHigh, dailyLow, dailyOpen] = request.security(symbol, "D", [close[1], high[1], low[1], open[1]], lookahead=barmerge.lookahead_on)
    currentPrice = request.security(symbol, timeframe.period, close, lookahead=barmerge.lookahead_off)
    change = dailyClose != 0 ? ((currentPrice - dailyClose) / dailyClose) * 100 : 0.0
    change

getATRRegimeScreen(string symbol) =>
    [atr, atrP20, atrP80] = request.security(symbol, "D", [ta.atr(vr_atrLength), ta.percentile_nearest_rank(ta.atr(vr_atrLength), vr_percentileLookback, 20), ta.percentile_nearest_rank(ta.atr(vr_atrLength), vr_percentileLookback, 80)], lookahead=barmerge.lookahead_on)
    [regime, regimeColor, score] = getVolatilityRegimeScreen(atr, atrP20, atrP80)
    [regime, regimeColor, score]

screen_change1 = get24HChange(shared_instrument1)
screen_change2 = get24HChange(shared_instrument2)
screen_change3 = get24HChange(shared_instrument3)
screen_change4 = get24HChange(shared_instrument4)
screen_change5 = get24HChange(shared_instrument5)

[screen_regime1, screen_color1, screen_regScore1] = getATRRegimeScreen(shared_instrument1)
[screen_regime2, screen_color2, screen_regScore2] = getATRRegimeScreen(shared_instrument2)
[screen_regime3, screen_color3, screen_regScore3] = getATRRegimeScreen(shared_instrument3)
[screen_regime4, screen_color4, screen_regScore4] = getATRRegimeScreen(shared_instrument4)
[screen_regime5, screen_color5, screen_regScore5] = getATRRegimeScreen(shared_instrument5)

screen_session1 = getSessionAlignment(shared_instrument1)
screen_session2 = getSessionAlignment(shared_instrument2)
screen_session3 = getSessionAlignment(shared_instrument3)
screen_session4 = getSessionAlignment(shared_instrument4)
screen_session5 = getSessionAlignment(shared_instrument5)

[screen_optimal1, screen_sessScore1] = isOptimalSession(screen_session1)
[screen_optimal2, screen_sessScore2] = isOptimalSession(screen_session2)
[screen_optimal3, screen_sessScore3] = isOptimalSession(screen_session3)
[screen_optimal4, screen_sessScore4] = isOptimalSession(screen_session4)
[screen_optimal5, screen_sessScore5] = isOptimalSession(screen_session5)

screen_momentumScore1 = math.min(math.abs(screen_change1) * 2, 10)
screen_momentumScore2 = math.min(math.abs(screen_change2) * 2, 10)
screen_momentumScore3 = math.min(math.abs(screen_change3) * 2, 10)
screen_momentumScore4 = math.min(math.abs(screen_change4) * 2, 10)
screen_momentumScore5 = math.min(math.abs(screen_change5) * 2, 10)

screen_score1 = (screen_regScore1 * 0.4) + (screen_sessScore1 * 0.3) + (screen_momentumScore1 * 0.3)
screen_score2 = (screen_regScore2 * 0.4) + (screen_sessScore2 * 0.3) + (screen_momentumScore2 * 0.3)
screen_score3 = (screen_regScore3 * 0.4) + (screen_sessScore3 * 0.3) + (screen_momentumScore3 * 0.3)
screen_score4 = (screen_regScore4 * 0.4) + (screen_sessScore4 * 0.3) + (screen_momentumScore4 * 0.3)
screen_score5 = (screen_regScore5 * 0.4) + (screen_sessScore5 * 0.3) + (screen_momentumScore5 * 0.3)

screen_rank1 = 1
screen_rank1 := screen_score2 > screen_score1 ? screen_rank1 + 1 : screen_rank1
screen_rank1 := screen_score3 > screen_score1 ? screen_rank1 + 1 : screen_rank1
screen_rank1 := screen_score4 > screen_score1 ? screen_rank1 + 1 : screen_rank1
screen_rank1 := screen_score5 > screen_score1 ? screen_rank1 + 1 : screen_rank1

screen_rank2 = 1
screen_rank2 := screen_score1 > screen_score2 ? screen_rank2 + 1 : screen_rank2
screen_rank2 := screen_score3 > screen_score2 ? screen_rank2 + 1 : screen_rank2
screen_rank2 := screen_score4 > screen_score2 ? screen_rank2 + 1 : screen_rank2
screen_rank2 := screen_score5 > screen_score2 ? screen_rank2 + 1 : screen_rank2

screen_rank3 = 1
screen_rank3 := screen_score1 > screen_score3 ? screen_rank3 + 1 : screen_rank3
screen_rank3 := screen_score2 > screen_score3 ? screen_rank3 + 1 : screen_rank3
screen_rank3 := screen_score4 > screen_score3 ? screen_rank3 + 1 : screen_rank3
screen_rank3 := screen_score5 > screen_score3 ? screen_rank3 + 1 : screen_rank3

screen_rank4 = 1
screen_rank4 := screen_score1 > screen_score4 ? screen_rank4 + 1 : screen_rank4
screen_rank4 := screen_score2 > screen_score4 ? screen_rank4 + 1 : screen_rank4
screen_rank4 := screen_score3 > screen_score4 ? screen_rank4 + 1 : screen_rank4
screen_rank4 := screen_score5 > screen_score4 ? screen_rank4 + 1 : screen_rank4

screen_rank5 = 1
screen_rank5 := screen_score1 > screen_score5 ? screen_rank5 + 1 : screen_rank5
screen_rank5 := screen_score2 > screen_score5 ? screen_rank5 + 1 : screen_rank5
screen_rank5 := screen_score3 > screen_score5 ? screen_rank5 + 1 : screen_rank5
screen_rank5 := screen_score4 > screen_score5 ? screen_rank5 + 1 : screen_rank5

screen_focus1 = screen_rank1 <= 2 ? "WATCH" : "SKIP"
screen_focus2 = screen_rank2 <= 2 ? "WATCH" : "SKIP"
screen_focus3 = screen_rank3 <= 2 ? "WATCH" : "SKIP"
screen_focus4 = screen_rank4 <= 2 ? "WATCH" : "SKIP"
screen_focus5 = screen_rank5 <= 2 ? "WATCH" : "SKIP"

screen_focusColor1 = screen_rank1 <= 2 ? COLOR_GREEN_BG_LIGHTER : COLOR_GRAY_BG_LIGHT
screen_focusColor2 = screen_rank2 <= 2 ? COLOR_GREEN_BG_LIGHTER : COLOR_GRAY_BG_LIGHT
screen_focusColor3 = screen_rank3 <= 2 ? COLOR_GREEN_BG_LIGHTER : COLOR_GRAY_BG_LIGHT
screen_focusColor4 = screen_rank4 <= 2 ? COLOR_GREEN_BG_LIGHTER : COLOR_GRAY_BG_LIGHT
screen_focusColor5 = screen_rank5 <= 2 ? COLOR_GREEN_BG_LIGHTER : COLOR_GRAY_BG_LIGHT

screen_rankColor1 = screen_rank1 <= 2 ? COLOR_GREEN_BG_LIGHT : screen_rank1 == 3 ? COLOR_YELLOW_BG_LIGHT : COLOR_GRAY_BG_LIGHT
screen_rankColor2 = screen_rank2 <= 2 ? COLOR_GREEN_BG_LIGHT : screen_rank2 == 3 ? COLOR_YELLOW_BG_LIGHT : COLOR_GRAY_BG_LIGHT
screen_rankColor3 = screen_rank3 <= 2 ? COLOR_GREEN_BG_LIGHT : screen_rank3 == 3 ? COLOR_YELLOW_BG_LIGHT : COLOR_GRAY_BG_LIGHT
screen_rankColor4 = screen_rank4 <= 2 ? COLOR_GREEN_BG_LIGHT : screen_rank4 == 3 ? COLOR_YELLOW_BG_LIGHT : COLOR_GRAY_BG_LIGHT
screen_rankColor5 = screen_rank5 <= 2 ? COLOR_GREEN_BG_LIGHT : screen_rank5 == 3 ? COLOR_YELLOW_BG_LIGHT : COLOR_GRAY_BG_LIGHT

// ============================================================================
// SECTION 4: CORRELATION PLOTS
// ============================================================================

plot(mc_corr_1_2, "EUR‚ÜîJPY", color=color.new(color.orange, 30), linewidth=2, display=display.all)
plot(mc_corr_1_3, "EUR‚ÜîGold", color=color.new(color.green, 30), linewidth=2, display=display.all)
plot(mc_corr_1_4, "EUR‚ÜîSilver", color=color.new(color.purple, 30), linewidth=2, display=display.all)
plot(mc_corr_2_5, "JPY‚ÜîOil", color=color.new(color.blue, 30), linewidth=2, display=display.all)
plot(mc_corr_3_4, "Gold‚ÜîSilver", color=color.new(color.yellow, 30), linewidth=2, display=display.all)

hline(0.5, "Conflict Threshold (+)", color=color.new(color.red, 70), linestyle=hline.style_dashed)
hline(-0.5, "Conflict Threshold (-)", color=color.new(color.red, 70), linestyle=hline.style_dashed)
hline(0, "Zero Correlation", color=color.new(color.gray, 80), linestyle=hline.style_dotted)

// CORRELATION LEGEND TABLE
var table correlationLegend = table.new(position=position.top_right, columns=3, rows=6, border_width=1, border_color=COLOR_BORDER, frame_color=COLOR_BORDER, frame_width=1)

if barstate.islast
    legendSize = size.small
    
    // Header
    table.cell(correlationLegend, 0, 0, "Color", text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_SECTION_HEADER_BG, text_size=legendSize)
    table.cell(correlationLegend, 1, 0, "Correlation Pair", text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_SECTION_HEADER_BG, text_size=legendSize)
    table.cell(correlationLegend, 2, 0, "Value", text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_SECTION_HEADER_BG, text_size=legendSize)
    
    // Orange - EUR‚ÜîJPY
    table.cell(correlationLegend, 0, 1, "‚óè", text_color=color.new(color.orange, 0), bgcolor=COLOR_CELL_BG_DARK, text_size=size.normal)
    table.cell(correlationLegend, 1, 1, "EUR ‚Üî JPY", text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=legendSize)
    table.cell(correlationLegend, 2, 1, str.tostring(mc_corr_1_2, "#.##"), text_color=math.abs(mc_corr_1_2) >= mc_correlationThreshold ? COLOR_RED : COLOR_GREEN, bgcolor=COLOR_CELL_BG_DARK, text_size=legendSize)
    
    // Green - EUR‚ÜîGold
    table.cell(correlationLegend, 0, 2, "‚óè", text_color=color.new(color.green, 0), bgcolor=COLOR_CELL_BG_DARK, text_size=size.normal)
    table.cell(correlationLegend, 1, 2, "EUR ‚Üî Gold", text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=legendSize)
    table.cell(correlationLegend, 2, 2, str.tostring(mc_corr_1_3, "#.##"), text_color=math.abs(mc_corr_1_3) >= mc_correlationThreshold ? COLOR_RED : COLOR_GREEN, bgcolor=COLOR_CELL_BG_DARK, text_size=legendSize)
    
    // Purple - EUR‚ÜîSilver
    table.cell(correlationLegend, 0, 3, "‚óè", text_color=color.new(color.purple, 0), bgcolor=COLOR_CELL_BG_DARK, text_size=size.normal)
    table.cell(correlationLegend, 1, 3, "EUR ‚Üî Silver", text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=legendSize)
    table.cell(correlationLegend, 2, 3, str.tostring(mc_corr_1_4, "#.##"), text_color=math.abs(mc_corr_1_4) >= mc_correlationThreshold ? COLOR_RED : COLOR_GREEN, bgcolor=COLOR_CELL_BG_DARK, text_size=legendSize)
    
    // Blue - JPY‚ÜîOil
    table.cell(correlationLegend, 0, 4, "‚óè", text_color=color.new(color.blue, 0), bgcolor=COLOR_CELL_BG_DARK, text_size=size.normal)
    table.cell(correlationLegend, 1, 4, "JPY ‚Üî Oil", text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=legendSize)
    table.cell(correlationLegend, 2, 4, str.tostring(mc_corr_2_5, "#.##"), text_color=math.abs(mc_corr_2_5) >= mc_correlationThreshold ? COLOR_RED : COLOR_GREEN, bgcolor=COLOR_CELL_BG_DARK, text_size=legendSize)
    
    // Yellow - Gold‚ÜîSilver
    table.cell(correlationLegend, 0, 5, "‚óè", text_color=color.new(color.yellow, 0), bgcolor=COLOR_CELL_BG_DARK, text_size=size.normal)
    table.cell(correlationLegend, 1, 5, "Gold ‚Üî Silver", text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=legendSize)
    table.cell(correlationLegend, 2, 5, str.tostring(mc_corr_3_4, "#.##"), text_color=math.abs(mc_corr_3_4) >= mc_correlationThreshold ? COLOR_RED : COLOR_GREEN, bgcolor=COLOR_CELL_BG_DARK, text_size=legendSize)

// ============================================================================
// SECTION 5: LEFT TABLE - MARKET SENTIMENT (MIDDLE_LEFT)
// v5.1 UPDATE: Fixed text sizes in Correlation Conflicts section
// ============================================================================

var table sentimentTable = table.new(position.middle_left, 10, 12, border_width=1, border_color=COLOR_BORDER, frame_width=1, frame_color=COLOR_BORDER, force_overlay=true)

if barstate.islast
    txtSize = unifiedTableSize == "auto" ? size.auto : unifiedTableSize == "tiny" ? size.tiny : unifiedTableSize == "small" ? size.small : unifiedTableSize == "normal" ? size.normal : unifiedTableSize == "large" ? size.large : size.huge
    
    // ROW 0: MAIN HEADER
    table.cell(sentimentTable, 0, 0, "MARKET SENTIMENT", text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_HEADER_BG, text_size=txtSize)
    table.merge_cells(sentimentTable, 0, 0, 9, 0)
    
    // ROW 1: SECTION HEADERS
    table.cell(sentimentTable, 0, 1, "üåç INTERMARKET", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.merge_cells(sentimentTable, 0, 1, 2, 1)
    
    table.cell(sentimentTable, 3, 1, "üéØ TRADING FOCUS", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.merge_cells(sentimentTable, 3, 1, 5, 1)
    
    table.cell(sentimentTable, 6, 1, "‚è∞ SESSION", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.merge_cells(sentimentTable, 6, 1, 7, 1)
    
    table.cell(sentimentTable, 8, 1, "üìä CURRENT CHART (" + syminfo.ticker + ")", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.merge_cells(sentimentTable, 8, 1, 9, 1)
    
    // ROW 2: VIX / Primary / Session / Regime
    vix_color = vix < im_vixRiskOnLevel ? COLOR_GREEN : vix > im_vixRiskOffLevel ? COLOR_RED : COLOR_YELLOW
    table.cell(sentimentTable, 0, 2, "VIX", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 1, 2, str.tostring(vix, "#.#"), text_color=vix_color, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 2, 2, vix_signal, text_color=vix_color, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    table.cell(sentimentTable, 3, 2, "1st", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 4, 2, mc_primaryPair, text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 5, 2, mc_primaryBias + " " + str.tostring(mc_primaryChange, "#.#") + "%", text_color=mc_primaryChange >= 0 ? COLOR_GREEN : COLOR_RED, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    mc_sessionColorCell = mc_currentSession == "LONDON" or mc_currentSession == "NY" ? COLOR_GREEN : mc_currentSession == "ASIA" ? COLOR_YELLOW : COLOR_RED
    table.cell(sentimentTable, 6, 2, "Now", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 7, 2, mc_currentSession, text_color=mc_sessionColorCell, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    vr_regimeBgColor = vr_currentRegime == "HIGH" ? COLOR_RED : vr_currentRegime == "LOW" ? COLOR_YELLOW : COLOR_GREEN
    table.cell(sentimentTable, 8, 2, "Regime", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 9, 2, vr_currentRegime + " [" + str.tostring(vr_atrPercentile, "#") + "%]", text_color=vr_regimeBgColor, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    // ROW 3: S&P / Secondary / Size / Current Size
    sp500_color = sp500 > sp500_ma20 ? COLOR_GREEN : COLOR_RED
    table.cell(sentimentTable, 0, 3, "S&P", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 1, 3, sp500_signal, text_color=sp500_color, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 2, 3, sp500 > sp500_ma20 ? "‚úÖ" : "‚ùå", text_color=sp500_color, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    table.cell(sentimentTable, 3, 3, "2nd", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 4, 3, mc_secondaryPair, text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 5, 3, mc_secondaryBias + " " + str.tostring(mc_secondaryChange, "#.#") + "%", text_color=mc_secondaryChange >= 0 ? COLOR_GREEN : COLOR_RED, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    table.cell(sentimentTable, 6, 3, "Size", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 7, 3, str.tostring(mc_sessionPositionSize, "#") + " EUR", text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    vr_positionColor = vr_positionSize < 100 ? COLOR_RED : COLOR_GREEN
    table.cell(sentimentTable, 8, 3, "Size", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 9, 3, str.tostring(vr_positionSize, "#") + " EUR", text_color=vr_positionColor, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    // ROW 4: DXY / (skip) / Reason / Adjustments
    dxy_color = dxy < dxy_ma50 ? COLOR_GREEN : COLOR_RED
    table.cell(sentimentTable, 0, 4, "DXY", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 1, 4, str.tostring(dxy, "#.#"), text_color=dxy_color, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 2, 4, dxy_signal, text_color=dxy_color, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    table.cell(sentimentTable, 3, 4, "", bgcolor=COLOR_CELL_BG_DARKER, text_size=txtSize)
    table.merge_cells(sentimentTable, 3, 4, 5, 4)
    
    table.cell(sentimentTable, 6, 4, im_adjustmentText, text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.merge_cells(sentimentTable, 6, 4, 7, 4)
    
    table.cell(sentimentTable, 8, 4, "Stop", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 9, 4, str.tostring(vr_stopMultiplier, "#.#") + "√óATR", text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    // ROW 5: Environment / (skip) / (skip) / Target
    table.cell(sentimentTable, 0, 5, "ENV", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 1, 5, im_environment, text_color=im_environment == "RISK-ON" ? COLOR_GREEN : im_environment == "RISK-OFF" ? COLOR_RED : COLOR_YELLOW, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.merge_cells(sentimentTable, 1, 5, 2, 5)
    
    table.cell(sentimentTable, 3, 5, "", bgcolor=COLOR_CELL_BG_DARKER)
    table.merge_cells(sentimentTable, 3, 5, 7, 5)
    
    table.cell(sentimentTable, 8, 5, "Target", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 9, 5, vr_targetRMultiple, text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    // ROW 6: (skip) / (skip) / (skip) / Entry
    table.cell(sentimentTable, 0, 6, "", bgcolor=COLOR_CELL_BG_DARKER)
    table.merge_cells(sentimentTable, 0, 6, 7, 6)
    
    table.cell(sentimentTable, 8, 6, "Entry", text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    table.cell(sentimentTable, 9, 6, vr_entryZone, text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
    
    // ROW 7: Separator
    table.cell(sentimentTable, 0, 7, "", bgcolor=COLOR_SEPARATOR, height=2)
    table.merge_cells(sentimentTable, 0, 7, 9, 7)
    
    // ROW 8: Correlation Header
    table.cell(sentimentTable, 0, 8, "‚ö†Ô∏è CORRELATION CONFLICTS", text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_RED_BG_LIGHTER, text_size=txtSize)
    table.merge_cells(sentimentTable, 0, 8, 9, 8)
    
    // ROW 9: Correlation Data
    table.cell(sentimentTable, 0, 9, "EUR‚ÜîJPY", text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_GRAY_BG, text_size=txtSize)
    table.cell(sentimentTable, 1, 9, str.tostring(mc_corr_1_2, "#.##"), text_color=COLOR_TEXT_WHITE, bgcolor=math.abs(mc_corr_1_2) >= mc_correlationThreshold ? COLOR_RED_BG_LIGHT : COLOR_GREEN_BG_LIGHT, text_size=txtSize)
    table.cell(sentimentTable, 2, 9, math.abs(mc_corr_1_2) >= mc_correlationThreshold ? "üî¥ 50" : "üü¢ Safe", text_color=COLOR_TEXT_WHITE, bgcolor=math.abs(mc_corr_1_2) >= mc_correlationThreshold ? COLOR_RED_BG_LIGHT : COLOR_GREEN_BG_LIGHT, text_size=txtSize)
    
    table.cell(sentimentTable, 3, 9, "EUR‚ÜîXAU", text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_GRAY_BG, text_size=txtSize)
    table.cell(sentimentTable, 4, 9, str.tostring(mc_corr_1_3, "#.##"), text_color=COLOR_TEXT_WHITE, bgcolor=math.abs(mc_corr_1_3) >= mc_correlationThreshold ? COLOR_RED_BG_LIGHT : COLOR_GREEN_BG_LIGHT, text_size=txtSize)
    table.cell(sentimentTable, 5, 9, math.abs(mc_corr_1_3) >= mc_correlationThreshold ? "üî¥ 50" : "üü¢ Safe", text_color=COLOR_TEXT_WHITE, bgcolor=math.abs(mc_corr_1_3) >= mc_correlationThreshold ? COLOR_RED_BG_LIGHT : COLOR_GREEN_BG_LIGHT, text_size=txtSize)
    
    table.cell(sentimentTable, 6, 9, "EUR‚ÜîXAG", text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_GRAY_BG, text_size=txtSize)
    table.cell(sentimentTable, 7, 9, str.tostring(mc_corr_1_4, "#.##"), text_color=COLOR_TEXT_WHITE, bgcolor=math.abs(mc_corr_1_4) >= mc_correlationThreshold ? COLOR_RED_BG_LIGHT : COLOR_GREEN_BG_LIGHT, text_size=txtSize)
    
    table.cell(sentimentTable, 8, 9, "JPY‚ÜîOIL / XAU‚ÜîXAG", text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_GRAY_BG, text_size=txtSize)
    table.cell(sentimentTable, 9, 9, str.tostring(mc_corr_2_5, "#.##") + " / " + str.tostring(mc_corr_3_4, "#.##"), text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_GRAY_BG_LIGHT, text_size=txtSize)
    
    // ROW 10: Correlation Footer
    table.cell(sentimentTable, 0, 10, "20-day rolling correlation | Threshold: ¬±" + str.tostring(mc_correlationThreshold, "#.##"), text_color=COLOR_YELLOW, bgcolor=COLOR_GRAY_BG_LIGHTER, text_size=txtSize)
    table.merge_cells(sentimentTable, 0, 10, 9, 10)
    
    // ROW 11: Footer / Summary
    vr_reasonText = ""
    if vr_currentRegime == "HIGH" and im_environment == "RISK-OFF"
        vr_reasonText := "‚ö†Ô∏è HIGH VOL + RISK-OFF: Both adjustments active"
    else if vr_currentRegime == "HIGH"
        vr_reasonText := "‚ö†Ô∏è HIGH VOLATILITY: 50% position reduction"
    else if im_environment == "RISK-OFF"
        vr_reasonText := "‚ö†Ô∏è RISK-OFF: 75% position sizing"
    else if vix > im_extremeVixLevel
        vr_reasonText := "üö® VIX EXTREME (>30): 50% position reduction"
    else if vr_currentRegime == "LOW"
        vr_reasonText := "‚ÑπÔ∏è LOW VOLATILITY: Lower targets (1.3R)"
    else
        vr_reasonText := "‚úÖ NORMAL CONDITIONS: Standard position sizing (100 EUR)"
    
    table.cell(sentimentTable, 0, 11, vr_reasonText, text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_BLUE_BG, text_size=txtSize)
    table.merge_cells(sentimentTable, 0, 11, 9, 11)

// ============================================================================
// SECTION 6: RIGHT TABLE - MULTI-INSTRUMENT SCREENING (MIDDLE_RIGHT)
// ============================================================================

var table screenTable = table.new(position=position.middle_right, columns=8, rows=7, border_width=1, border_color=COLOR_BORDER, frame_color=COLOR_BORDER, frame_width=1, force_overlay=true)

if barstate.islast
    txtSize = unifiedTableSize == "auto" ? size.auto : unifiedTableSize == "tiny" ? size.tiny : unifiedTableSize == "small" ? size.small : unifiedTableSize == "normal" ? size.normal : unifiedTableSize == "large" ? size.large : size.huge
    
    // Header
    table.cell(screenTable, 0, 0, "MULTI-INSTRUMENT SCREENING", text_color=COLOR_TEXT_WHITE, bgcolor=COLOR_HEADER_BG, text_size=txtSize)
    table.merge_cells(screenTable, 0, 0, 7, 0)
    
    // Column headers
    table.cell(screenTable, 0, 1, "Rank", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.cell(screenTable, 1, 1, "Instrument", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.cell(screenTable, 2, 1, "24H %", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.cell(screenTable, 3, 1, "Regime", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.cell(screenTable, 4, 1, "Session", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.cell(screenTable, 5, 1, "Optimal", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.cell(screenTable, 6, 1, "Score", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    table.cell(screenTable, 7, 1, "Focus", text_color=COLOR_TEXT_MEDIUM, bgcolor=COLOR_SECTION_HEADER_BG, text_size=txtSize)
    
    // Extract short names
    var string name1 = na
    var string name2 = na
    var string name3 = na
    var string name4 = na
    var string name5 = na
    
    if str.contains(shared_instrument1, ":")
        parts1 = str.split(shared_instrument1, ":")
        name1 := array.get(parts1, 1)
    else
        name1 := shared_instrument1
        
    if str.contains(shared_instrument2, ":")
        parts2 = str.split(shared_instrument2, ":")
        name2 := array.get(parts2, 1)
    else
        name2 := shared_instrument2
        
    if str.contains(shared_instrument3, ":")
        parts3 = str.split(shared_instrument3, ":")
        name3 := array.get(parts3, 1)
    else
        name3 := shared_instrument3
        
    if str.contains(shared_instrument4, ":")
        parts4 = str.split(shared_instrument4, ":")
        name4 := array.get(parts4, 1)
    else
        name4 := shared_instrument4
        
    if str.contains(shared_instrument5, ":")
        parts5 = str.split(shared_instrument5, ":")
        name5 := array.get(parts5, 1)
    else
        name5 := shared_instrument5
    
    // Create sorted index array based on scores (highest to lowest)
    var int[] sortedIndices = array.from(1, 2, 3, 4, 5)
    var float[] scores = array.from(screen_score1, screen_score2, screen_score3, screen_score4, screen_score5)
    
    // Bubble sort descending (highest score first)
    for i = 0 to 4
        for j = 0 to 3 - i
            if array.get(scores, j) < array.get(scores, j + 1)
                // Swap scores
                tempScore = array.get(scores, j)
                array.set(scores, j, array.get(scores, j + 1))
                array.set(scores, j + 1, tempScore)
                // Swap indices
                tempIdx = array.get(sortedIndices, j)
                array.set(sortedIndices, j, array.get(sortedIndices, j + 1))
                array.set(sortedIndices, j + 1, tempIdx)
    
    // Display instruments in sorted order (best score at top)
    for row = 0 to 4
        instIdx = array.get(sortedIndices, row)
        displayRank = row + 1
        tableRow = row + 2
        
        // Select data based on instrument index
        instName = instIdx == 1 ? name1 : instIdx == 2 ? name2 : instIdx == 3 ? name3 : instIdx == 4 ? name4 : name5
        instRank = instIdx == 1 ? screen_rank1 : instIdx == 2 ? screen_rank2 : instIdx == 3 ? screen_rank3 : instIdx == 4 ? screen_rank4 : screen_rank5
        instChange = instIdx == 1 ? screen_change1 : instIdx == 2 ? screen_change2 : instIdx == 3 ? screen_change3 : instIdx == 4 ? screen_change4 : screen_change5
        instRegime = instIdx == 1 ? screen_regime1 : instIdx == 2 ? screen_regime2 : instIdx == 3 ? screen_regime3 : instIdx == 4 ? screen_regime4 : screen_regime5
        instColor = instIdx == 1 ? screen_color1 : instIdx == 2 ? screen_color2 : instIdx == 3 ? screen_color3 : instIdx == 4 ? screen_color4 : screen_color5
        instSession = instIdx == 1 ? screen_session1 : instIdx == 2 ? screen_session2 : instIdx == 3 ? screen_session3 : instIdx == 4 ? screen_session4 : screen_session5
        instOptimal = instIdx == 1 ? screen_optimal1 : instIdx == 2 ? screen_optimal2 : instIdx == 3 ? screen_optimal3 : instIdx == 4 ? screen_optimal4 : screen_optimal5
        instScore = instIdx == 1 ? screen_score1 : instIdx == 2 ? screen_score2 : instIdx == 3 ? screen_score3 : instIdx == 4 ? screen_score4 : screen_score5
        instFocus = instIdx == 1 ? screen_focus1 : instIdx == 2 ? screen_focus2 : instIdx == 3 ? screen_focus3 : instIdx == 4 ? screen_focus4 : screen_focus5
        instRankColor = instIdx == 1 ? screen_rankColor1 : instIdx == 2 ? screen_rankColor2 : instIdx == 3 ? screen_rankColor3 : instIdx == 4 ? screen_rankColor4 : screen_rankColor5
        instFocusColor = instIdx == 1 ? screen_focusColor1 : instIdx == 2 ? screen_focusColor2 : instIdx == 3 ? screen_focusColor3 : instIdx == 4 ? screen_focusColor4 : screen_focusColor5
        
        // Populate table row
        table.cell(screenTable, 0, tableRow, str.tostring(instRank), text_color=COLOR_TEXT_WHITE, bgcolor=instRankColor, text_size=txtSize)
        table.cell(screenTable, 1, tableRow, instName, text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
        table.cell(screenTable, 2, tableRow, str.tostring(instChange, "#.##") + "%", text_color=instChange >= 0 ? COLOR_GREEN : COLOR_RED, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
        table.cell(screenTable, 3, tableRow, instRegime, text_color=color.new(color.black, 0), bgcolor=instColor, text_size=txtSize)
        table.cell(screenTable, 4, tableRow, instSession, text_color=COLOR_TEXT_DIM, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
        table.cell(screenTable, 5, tableRow, instOptimal ? "‚úì" : "-", text_color=instOptimal ? COLOR_GREEN : COLOR_GRAY, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
        table.cell(screenTable, 6, tableRow, str.tostring(instScore, "#.#"), text_color=COLOR_TEXT_LIGHT, bgcolor=COLOR_CELL_BG_DARK, text_size=txtSize)
        table.cell(screenTable, 7, tableRow, instFocus, text_color=COLOR_TEXT_WHITE, bgcolor=instFocusColor, text_size=txtSize)

// ============================================================================
// SECTION 7: ALERTS
// ============================================================================

vr_regimeChanged = vr_currentRegime != vr_currentRegime[1]
vr_highRegimeEntered = vr_currentRegime == "HIGH" and vr_currentRegime[1] != "HIGH"
im_extremeVix = vix > im_extremeVixLevel
im_riskOffEnvironment = im_environment == "RISK-OFF" and im_environment[1] != "RISK-OFF"

if vr_regimeChanged
    alert("Volatility regime changed to " + vr_currentRegime, alert.freq_once_per_bar)

if vr_highRegimeEntered
    alert("‚ö†Ô∏è HIGH volatility regime detected - MANDATORY position reduction to 50 EUR!", alert.freq_once_per_bar)

if im_extremeVix
    alert("‚ö†Ô∏è VIX EXTREME (>30) - Consider 50 EUR positions or no trading!", alert.freq_once_per_bar)

if im_riskOffEnvironment
    alert("‚ö†Ô∏è RISK-OFF environment detected - Adjust position sizes!", alert.freq_once_per_bar)

mc_highCorrelationDetected = math.abs(mc_corr_1_2) >= mc_correlationThreshold or math.abs(mc_corr_1_3) >= mc_correlationThreshold or math.abs(mc_corr_2_5) >= mc_correlationThreshold

alertcondition(vr_regimeChanged, title="Volatility Regime Changed", message="Volatility regime has changed - check indicator")
alertcondition(vr_highRegimeEntered, title="HIGH Volatility Regime", message="HIGH volatility - reduce to 50 EUR")
alertcondition(im_extremeVix, title="VIX Extreme Level", message="VIX > 30 - Consider 50 EUR or no trading")
alertcondition(im_riskOffEnvironment, title="Risk-Off Environment", message="Risk-off detected - adjust positions")
alertcondition(mc_highCorrelationDetected, title="Correlation Conflict", message="High correlation - check sizing!")

// ============================================================================
// END OF INDICATOR v5.7
// Changes: 
// - Fixed text sizes in Correlation Conflicts section to use txtSize
// - Added score-based sorting to Multi-Instrument Screening table
// - Added 2 correlation plots: EUR‚ÜîSilver (purple) and Gold‚ÜîSilver (yellow)
// - Added correlation legend table (top-right of indicator pane)
// - Legend shows: Color dot, pair name, current value with conflict coloring
// ============================================================================