// FRAMEWORK 2.0 - STAGE 5: TRIGGER - MASTER DETECTION v5.1 (CTA OPTIMIZED)
// OPTIMIZED FOR SCREENSHOT VISIBILITY - Text Consistency & Color Fix
//@version=6
indicator("ğŸ¯ TRIGGER MASTER", overlay=true, max_labels_count=20, max_boxes_count=10)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - STREAMLINED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Entry Zone Settings
entryZoneMultiplier = input.float(0.5, "Entry Zone (Ã—ATR)", minval=0.1, maxval=2.0, step=0.1, group="ğŸ“ Entry Zone")
showEntryZone = input.bool(false, "Show Entry Zone", group="ğŸ“ Entry Zone")

// Quality Pattern Settings
minBodyPercent = input.float(40.0, "Min Body %", minval=20, maxval=80, step=5, group="ğŸ“Š Pattern Quality")
minClosePercent = input.float(50.0, "Min Close %", minval=30, maxval=80, step=5, group="ğŸ“Š Pattern Quality")

// Volume Settings
volMultiplier = input.float(1.2, "Volume Multiplier", minval=1.0, maxval=3.0, step=0.1, group="ğŸ“ˆ Volume")
volLength = input.int(50, "Volume SMA Length", minval=10, maxval=200, step=10, group="ğŸ“ˆ Volume")

// Signal Age Settings
maxSignalAge = input.int(5, "Max Signal Age (bars)", minval=1, maxval=20, step=1, group="â±ï¸ Signal Age")

// Display Settings
tableLoc = input.string("top_right", "Table Position", options=["top_right", "top_left", "bottom_right", "bottom_left"], group="ğŸ¨ Display")
showLabels = input.bool(false, "Show Trigger Labels", group="ğŸ¨ Display")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL DETECTION (from 5-min chart)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Request signal from higher timeframe (5-min on 1-min chart)
[signalHigh, signalLow, signalDirection, signalTime] = request.security(syminfo.tickerid, "5", [high[1], low[1], close[1] > open[1] ? 1 : close[1] < open[1] ? -1 : 0, time[1]], lookahead=barmerge.lookahead_on)

// Calculate bars since signal
barsFromSignal = (time - signalTime) / (timeframe.in_seconds() * 1000)
signalAge = math.floor(barsFromSignal)
signalTooOld = signalAge > maxSignalAge

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ATR CALCULATION (for entry zones)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

atr = ta.atr(14)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTRY ZONE CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Entry zone based on signal candle
entryZoneUpper = signalDirection == 1 ? signalHigh + (atr * entryZoneMultiplier) : na
entryZoneLower = signalDirection == 1 ? signalLow - (atr * entryZoneMultiplier) : na

entryZoneUpperShort = signalDirection == -1 ? signalHigh + (atr * entryZoneMultiplier) : na
entryZoneLowerShort = signalDirection == -1 ? signalLow - (atr * entryZoneMultiplier) : na

// Check if price is in entry zone
inEntryZoneLong = signalDirection == 1 and close >= entryZoneLower and close <= entryZoneUpper
inEntryZoneShort = signalDirection == -1 and close >= entryZoneLowerShort and close <= entryZoneUpperShort
inEntryZone = inEntryZoneLong or inEntryZoneShort

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATTERN QUALITY ANALYSIS (1-min candle)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

candleRange = high - low
candleBody = math.abs(close - open)
bodyPercent = candleRange > 0 ? (candleBody / candleRange) * 100 : 0

closePosition = candleRange > 0 ? ((close - low) / candleRange) * 100 : 50

// Quality checks
hasConviction = bodyPercent >= minBodyPercent
hasGoodClose = signalDirection == 1 ? closePosition >= minClosePercent : closePosition <= (100 - minClosePercent)
qualityPattern = hasConviction and hasGoodClose

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOLUME CONFIRMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

volSMA = ta.sma(volume, volLength)
volRatio = volSMA > 0 ? volume / volSMA : 0
volumeConfirmed = volRatio >= volMultiplier

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIGGER CONDITIONS (ALL 3 MUST PASS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

trigger1_Pass = inEntryZone and not signalTooOld
trigger2_Pass = qualityPattern
trigger3_Pass = volumeConfirmed

allTriggersPass = trigger1_Pass and trigger2_Pass and trigger3_Pass

// Signal detected but no valid trigger
signalExists = signalDirection != 0 and not signalTooOld

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUAL DISPLAYS - OPTIMIZED FOR VISIBILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Entry Zone Boxes (Visual Guide)
var box entryBox = na
if showEntryZone and signalExists
    if signalDirection == 1 and not na(entryZoneLower)
        box.delete(entryBox)
        entryBox := box.new(bar_index, entryZoneUpper, bar_index + 10, entryZoneLower, border_color=color.new(color.green, 60), bgcolor=color.new(color.green, 90), border_width=2, extend=extend.right, border_style=line.style_dashed)
    if signalDirection == -1 and not na(entryZoneLowerShort)
        box.delete(entryBox)
        entryBox := box.new(bar_index, entryZoneUpperShort, bar_index + 10, entryZoneLowerShort, border_color=color.new(color.red, 60), bgcolor=color.new(color.red, 90), border_width=2, extend=extend.right, border_style=line.style_dashed)

// Trigger Labels - ONLY WHEN TRIGGERED
if allTriggersPass and showLabels
    label.new(bar_index, high, text=signalDirection == 1 ? "ğŸ¯ LONG" : "ğŸ¯ SHORT", color=signalDirection == 1 ? color.new(color.green, 0) : color.new(color.red, 0), textcolor=color.white, style=signalDirection == 1 ? label.style_label_up : label.style_label_down, size=size.normal)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS TABLE - HIGHLY OPTIMIZED FOR READABILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table statusTable = table.new(position=tableLoc == "top_right" ? position.top_right : tableLoc == "top_left" ? position.top_left : tableLoc == "bottom_right" ? position.bottom_right : position.bottom_left, columns=2, rows=7, bgcolor=color.new(color.black, 10), border_width=2, border_color=color.new(color.gray, 50))

if barstate.islast
    // Header - Most Prominent
    table.cell(statusTable, 0, 0, "STATUS", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.normal, text_halign=text.align_center)
    
    table.cell(statusTable, 1, 0, allTriggersPass ? "GO âœ“" : signalExists ? "WAIT" : "NO", text_color=color.white, bgcolor=allTriggersPass ? color.new(color.green, 0) : signalExists ? color.new(color.orange, 0) : color.new(color.red, 0), text_size=size.large, text_halign=text.align_center)
    
    // Signal Direction
    table.cell(statusTable, 0, 1, "Signal:", text_color=color.new(color.silver, 0), text_size=size.normal)
    
    signalText = signalDirection == 1 ? "LONG" : signalDirection == -1 ? "SHORT" : "NONE"
    signalColor = signalDirection == 1 ? color.new(color.lime, 0) : signalDirection == -1 ? color.new(color.red, 0) : color.new(color.gray, 0)
    table.cell(statusTable, 1, 1, signalText, text_color=signalColor, text_size=size.normal, text_halign=text.align_right)
    
    // Trigger 1: Entry Zone
    table.cell(statusTable, 0, 2, "1.Zone:", text_color=color.new(color.silver, 0), text_size=size.normal)
    
    table.cell(statusTable, 1, 2, trigger1_Pass ? "âœ“" : "âœ—", text_color=trigger1_Pass ? color.new(color.lime, 0) : color.new(color.red, 0), text_size=size.normal, text_halign=text.align_right)
    
    // Trigger 2: Pattern Quality
    table.cell(statusTable, 0, 3, "2.Pattern:", text_color=color.new(color.silver, 0), text_size=size.normal)
    
    patternText = str.tostring(bodyPercent, "#") + "%"
    table.cell(statusTable, 1, 3, trigger2_Pass ? "âœ“ " + patternText : "âœ— " + patternText, text_color=trigger2_Pass ? color.new(color.lime, 0) : color.new(color.red, 0), text_size=size.normal, text_halign=text.align_right)
    
    // Trigger 3: Volume
    table.cell(statusTable, 0, 4, "3.Volume:", text_color=color.new(color.silver, 0), text_size=size.normal)
    
    volText = str.tostring(volRatio, "#.#") + "x"
    table.cell(statusTable, 1, 4, trigger3_Pass ? "âœ“ " + volText : "âœ— " + volText, text_color=trigger3_Pass ? color.new(color.lime, 0) : color.new(color.red, 0), text_size=size.normal, text_halign=text.align_right)
    
    // Signal Age
    table.cell(statusTable, 0, 5, "Age:", text_color=color.new(color.silver, 0), text_size=size.normal)
    
    ageText = str.tostring(signalAge, "#") + "/" + str.tostring(maxSignalAge, "#")
    ageColor = signalTooOld ? color.new(color.red, 0) : signalAge > maxSignalAge * 0.7 ? color.new(color.orange, 0) : color.new(color.lime, 0)
    table.cell(statusTable, 1, 5, ageText, text_color=ageColor, text_size=size.normal, text_halign=text.align_right)
    
    // Entry Zone Range
    if signalExists
        zoneUpper = signalDirection == 1 ? entryZoneUpper : entryZoneUpperShort
        zoneLower = signalDirection == 1 ? entryZoneLower : entryZoneLowerShort
        
        table.cell(statusTable, 0, 6, "Zone:", text_color=color.new(color.silver, 0), text_size=size.small)
        
        zoneText = str.tostring(zoneLower, format.mintick) + "-" + str.tostring(zoneUpper, format.mintick)
        table.cell(statusTable, 1, 6, zoneText, text_color=color.new(color.white, 0), text_size=size.small, text_halign=text.align_right)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if allTriggersPass
    alert("ğŸ¯ TRIGGER CONFIRMED: " + (signalDirection == 1 ? "LONG" : "SHORT") + " @ " + str.tostring(close), alert.freq_once_per_bar)

if signalExists and not allTriggersPass and barstate.isconfirmed
    alert("â³ Signal active but trigger conditions not met", alert.freq_once_per_bar)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHANGELOG v5.1
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// - Fixed text size consistency: All rows now use size.normal (except header=large, zone=small)
// - Improved color scheme: Changed gray to silver for better contrast
// - Enhanced color visibility: Changed green to lime, added color.new() for all colors
// - Consistent formatting across all table cells