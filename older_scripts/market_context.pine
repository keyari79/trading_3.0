//@version=6
indicator("FW2 Market Context - Single Table v4.0", overlay=false, max_labels_count=500, max_lines_count=500, max_bars_back=5000)

// ============================================================================
// FRAMEWORK 2.0 - UNIFIED MARKET DASHBOARD (SINGLE TABLE LAYOUT)
// ============================================================================
// Combines: Intermarket + Trading Focus + Session + Volatility + Correlations
// Display: ONE wide table with multiple columns + correlation plots
// VERSION: v4.0 - Consolidated single table design
// ============================================================================

// ============================================================================
// SECTION 1: INPUT PARAMETERS (UNCHANGED FROM v3.0)
// ============================================================================

// --- VOLATILITY REGIME Settings ---
vr_atrLength = input.int(14, "ATR Period", minval=5, maxval=50, group="‚ö° Volatility Regime")
vr_percentileLookback = input.int(100, "Percentile Lookback", minval=20, maxval=252, group="‚ö° Volatility Regime")
vr_lowThreshold = input.float(20.0, "LOW Regime Threshold", minval=0, maxval=100, step=5, group="‚ö° Volatility Regime")
vr_highThreshold = input.float(80.0, "HIGH Regime Threshold", minval=0, maxval=100, step=5, group="‚ö° Volatility Regime")
vr_basePositionSize = input.float(100.0, "Base Position Size (EUR)", minval=10, group="‚ö° Volatility Regime")
vr_highRegimeReduction = input.float(0.5, "HIGH Regime Reduction", minval=0.1, maxval=1.0, step=0.1, group="‚ö° Volatility Regime")

// --- MARKET CONTEXT - Correlation Settings ---
mc_correlationPeriod = input.int(20, "Correlation Lookback Period", minval=5, maxval=100, group="üìä Market Context - Correlation")
mc_correlationThreshold = input.float(0.5, "Conflict Threshold", minval=0.1, maxval=1.0, step=0.05, group="üìä Market Context - Correlation")

// --- INTERMARKET Settings ---
im_showIntermarket = input.bool(true, "Show Intermarket Context", group="üåç Intermarket Analysis")
im_vixRiskOnLevel = input.float(20.0, "VIX Risk-On Level", minval=10, maxval=30, group="üåç Intermarket Analysis")
im_vixRiskOffLevel = input.float(25.0, "VIX Risk-Off Level", minval=20, maxval=40, group="üåç Intermarket Analysis")
im_extremeVixLevel = input.float(30.0, "VIX Extreme Level", minval=25, maxval=50, group="üåç Intermarket Analysis")

// --- MARKET CONTEXT - Instrument Selection ---
shared_instrument1 = input.symbol("FX:EURUSD", "Instrument 1 (EUR/USD)", group="üåê Shared Instruments")
shared_instrument2 = input.symbol("FX:USDJPY", "Instrument 2 (USD/JPY)", group="üåê Shared Instruments")
shared_instrument3 = input.symbol("FX:XAUUSD", "Instrument 3 (Gold)", group="üåê Shared Instruments")
shared_instrument4 = input.symbol("FX:XAGUSD", "Instrument 4 (Silver)", group="üåê Shared Instruments")
shared_instrument5 = input.symbol("TVC:USOIL", "Instrument 5 (Oil)", group="üåê Shared Instruments")

// --- MARKET CONTEXT - Trading Focus ---
mc_showConviction = input.bool(true, "Show Trading Focus", group="üìä Market Context - Focus")
mc_ccy1 = input.symbol("FX:EURUSD", "Currency Pair 1", group="üìä Market Context - Focus")
mc_ccy2 = input.symbol("FX:USDJPY", "Currency Pair 2", group="üìä Market Context - Focus")
mc_ccy3 = input.symbol("FX:GBPUSD", "Currency Pair 3", group="üìä Market Context - Focus")
mc_ccy4 = input.symbol("FX:AUDUSD", "Currency Pair 4", group="üìä Market Context - Focus")

// --- MARKET CONTEXT - Session Settings ---
mc_showSessionStrength = input.bool(true, "Show Session Strength", group="üìä Market Context - Session")
mc_basePositionSize = input.float(100.0, "Session Base Position (EUR)", minval=10, group="üìä Market Context - Session")

// ============================================================================
// SECTION 2: ALL CALCULATIONS (UNCHANGED FROM v3.0)
// ============================================================================

// --- INTERMARKET DATA ---
dxy = request.security("TVC:DXY", timeframe.period, close)
dxy_ma50 = request.security("TVC:DXY", timeframe.period, ta.sma(close, 50))
vix = request.security("CBOE:VIX", timeframe.period, close)
sp500 = request.security("SP:SPX", timeframe.period, close)
sp500_ma20 = request.security("SP:SPX", timeframe.period, ta.sma(close, 20))

vix_signal = vix < im_vixRiskOnLevel ? "RISK-ON" : vix > im_vixRiskOffLevel ? "RISK-OFF" : "NEUTRAL"
sp500_signal = sp500 > sp500_ma20 ? "BULLISH" : "BEARISH"
dxy_signal = dxy < dxy_ma50 ? "WEAK $" : "STRONG $"

risk_on_count = (vix < im_vixRiskOnLevel ? 1 : 0) + (sp500 > sp500_ma20 ? 1 : 0) + (dxy < dxy_ma50 ? 1 : 0)
risk_off_count = (vix > im_vixRiskOffLevel ? 1 : 0) + (sp500 < sp500_ma20 ? 1 : 0) + (dxy > dxy_ma50 ? 1 : 0)

im_environment = risk_on_count >= 2 ? "RISK-ON" : risk_off_count >= 2 ? "RISK-OFF" : "NEUTRAL"
im_env_color = im_environment == "RISK-ON" ? color.new(color.green, 30) : im_environment == "RISK-OFF" ? color.new(color.red, 30) : color.new(color.gray, 30)

im_positionAdjustment = im_environment == "RISK-OFF" ? 0.75 : vix > im_extremeVixLevel ? 0.5 : 1.0
im_adjustmentText = im_environment == "RISK-OFF" ? "Risk-Off: 75%" : vix > im_extremeVixLevel ? "EXTREME: 50%" : "Normal: 100%"

// --- VOLATILITY REGIME (CURRENT SYMBOL) ---
vr_dailyATR = request.security(syminfo.tickerid, "D", ta.atr(vr_atrLength), lookahead=barmerge.lookahead_off)
vr_atrValue = vr_dailyATR

var float[] vr_atrHistory = array.new_float(0)
if barstate.islast
    array.clear(vr_atrHistory)
    for i = 0 to math.min(vr_percentileLookback - 1, bar_index)
        historicalATR = vr_dailyATR[i]
        if not na(historicalATR)
            array.push(vr_atrHistory, historicalATR)

vr_atrPercentile = 0.0
if barstate.islast and array.size(vr_atrHistory) > 0
    sortedATR = array.copy(vr_atrHistory)
    array.sort(sortedATR, order.ascending)
    currentRank = 0
    arraySize = array.size(sortedATR)
    for i = 0 to arraySize - 1
        if array.get(sortedATR, i) <= vr_atrValue
            currentRank := i + 1
    vr_atrPercentile := (currentRank / arraySize) * 100

var string vr_currentRegime = "NORMAL"
var color vr_regimeColor = color.green

if vr_atrPercentile < vr_lowThreshold
    vr_currentRegime := "LOW"
    vr_regimeColor := color.new(color.yellow, 30)
else if vr_atrPercentile > vr_highThreshold
    vr_currentRegime := "HIGH"
    vr_regimeColor := color.new(color.red, 30)
else
    vr_currentRegime := "NORMAL"
    vr_regimeColor := color.new(color.green, 30)

vr_baseAdjustment = vr_currentRegime == "HIGH" ? vr_highRegimeReduction : 1.0
vr_positionSize = vr_basePositionSize * vr_baseAdjustment * im_positionAdjustment

vr_stopMultiplier = vr_currentRegime == "HIGH" ? 1.5 : vr_currentRegime == "LOW" ? 0.8 : 1.0
vr_targetRMultiple = vr_currentRegime == "HIGH" ? "1.5-2.0R" : vr_currentRegime == "LOW" ? "1.3R" : "1.5-2.0R"
vr_entryZone = vr_currentRegime == "HIGH" ? "¬±0.75 ATR" : "¬±0.5 ATR"

// --- MULTI-INSTRUMENT VOLATILITY ---
vr_getRegime(string ticker) =>
    instATR = request.security(ticker, "D", ta.atr(vr_atrLength), lookahead=barmerge.lookahead_off)
    var float[] instHistory = array.new_float(0)
    array.clear(instHistory)
    for i = 0 to math.min(vr_percentileLookback - 1, bar_index)
        histATR = instATR[i]
        if not na(histATR)
            array.push(instHistory, histATR)
    instPercentile = 0.0
    if array.size(instHistory) > 0
        sortedInstATR = array.copy(instHistory)
        array.sort(sortedInstATR, order.ascending)
        instRank = 0
        instSize = array.size(sortedInstATR)
        for i = 0 to instSize - 1
            if array.get(sortedInstATR, i) <= instATR
                instRank := i + 1
        instPercentile := (instRank / instSize) * 100
    regime = instPercentile < vr_lowThreshold ? "LOW" : instPercentile > vr_highThreshold ? "HIGH" : "NORMAL"
    [regime, instPercentile]

[vr_regime1, vr_percentile1] = vr_getRegime(shared_instrument1)
[vr_regime2, vr_percentile2] = vr_getRegime(shared_instrument2)
[vr_regime3, vr_percentile3] = vr_getRegime(shared_instrument3)
[vr_regime4, vr_percentile4] = vr_getRegime(shared_instrument4)
[vr_regime5, vr_percentile5] = vr_getRegime(shared_instrument5)

vr_posSize1 = (vr_regime1 == "HIGH" ? vr_basePositionSize * vr_highRegimeReduction : vr_basePositionSize) * im_positionAdjustment
vr_posSize2 = (vr_regime2 == "HIGH" ? vr_basePositionSize * vr_highRegimeReduction : vr_basePositionSize) * im_positionAdjustment
vr_posSize3 = (vr_regime3 == "HIGH" ? vr_basePositionSize * vr_highRegimeReduction : vr_basePositionSize) * im_positionAdjustment
vr_posSize4 = (vr_regime4 == "HIGH" ? vr_basePositionSize * vr_highRegimeReduction : vr_basePositionSize) * im_positionAdjustment
vr_posSize5 = (vr_regime5 == "HIGH" ? vr_basePositionSize * vr_highRegimeReduction : vr_basePositionSize) * im_positionAdjustment

// --- CORRELATIONS ---
mc_price1 = request.security(shared_instrument1, "D", close)
mc_price2 = request.security(shared_instrument2, "D", close)
mc_price3 = request.security(shared_instrument3, "D", close)
mc_price4 = request.security(shared_instrument4, "D", close)
mc_price5 = request.security(shared_instrument5, "D", close)

mc_corr_1_2 = ta.correlation(mc_price1, mc_price2, mc_correlationPeriod)
mc_corr_1_3 = ta.correlation(mc_price1, mc_price3, mc_correlationPeriod)
mc_corr_1_4 = ta.correlation(mc_price1, mc_price4, mc_correlationPeriod)
mc_corr_2_5 = ta.correlation(mc_price2, mc_price5, mc_correlationPeriod)
mc_corr_3_4 = ta.correlation(mc_price3, mc_price4, mc_correlationPeriod)

// --- TRADING FOCUS ---
mc_dailyChange() => (close - close[1]) / close[1] * 100

mc_change1 = request.security(mc_ccy1, "D", mc_dailyChange())
mc_change2 = request.security(mc_ccy2, "D", mc_dailyChange())
mc_change3 = request.security(mc_ccy3, "D", mc_dailyChange())
mc_change4 = request.security(mc_ccy4, "D", mc_dailyChange())

mc_pair1Name = str.length(mc_ccy1) >= 6 ? str.substring(mc_ccy1, str.length(mc_ccy1) - 6) : mc_ccy1
mc_pair2Name = str.length(mc_ccy2) >= 6 ? str.substring(mc_ccy2, str.length(mc_ccy2) - 6) : mc_ccy2
mc_pair3Name = str.length(mc_ccy3) >= 6 ? str.substring(mc_ccy3, str.length(mc_ccy3) - 6) : mc_ccy3
mc_pair4Name = str.length(mc_ccy4) >= 6 ? str.substring(mc_ccy4, str.length(mc_ccy4) - 6) : mc_ccy4

mc_maxChange = math.max(mc_change1, math.max(mc_change2, math.max(mc_change3, mc_change4)))
var string mc_primaryPair = ""
var float mc_primaryChange = 0.0
var string mc_secondaryPair = ""
var float mc_secondaryChange = 0.0

if mc_change1 == mc_maxChange
    mc_primaryPair := mc_pair1Name
    mc_primaryChange := mc_change1
    mc_secondaryChange := math.max(mc_change2, math.max(mc_change3, mc_change4))
    if mc_change2 == mc_secondaryChange
        mc_secondaryPair := mc_pair2Name
    else if mc_change3 == mc_secondaryChange
        mc_secondaryPair := mc_pair3Name
    else
        mc_secondaryPair := mc_pair4Name
else if mc_change2 == mc_maxChange
    mc_primaryPair := mc_pair2Name
    mc_primaryChange := mc_change2
    mc_secondaryChange := math.max(mc_change1, math.max(mc_change3, mc_change4))
    if mc_change1 == mc_secondaryChange
        mc_secondaryPair := mc_pair1Name
    else if mc_change3 == mc_secondaryChange
        mc_secondaryPair := mc_pair3Name
    else
        mc_secondaryPair := mc_pair4Name
else if mc_change3 == mc_maxChange
    mc_primaryPair := mc_pair3Name
    mc_primaryChange := mc_change3
    mc_secondaryChange := math.max(mc_change1, math.max(mc_change2, mc_change4))
    if mc_change1 == mc_secondaryChange
        mc_secondaryPair := mc_pair1Name
    else if mc_change2 == mc_secondaryChange
        mc_secondaryPair := mc_pair2Name
    else
        mc_secondaryPair := mc_pair4Name
else
    mc_primaryPair := mc_pair4Name
    mc_primaryChange := mc_change4
    mc_secondaryChange := math.max(mc_change1, math.max(mc_change2, mc_change3))
    if mc_change1 == mc_secondaryChange
        mc_secondaryPair := mc_pair1Name
    else if mc_change2 == mc_secondaryChange
        mc_secondaryPair := mc_pair2Name
    else
        mc_secondaryPair := mc_pair3Name

mc_primaryBias = mc_primaryChange > 0 ? "BUY" : "SELL"
mc_secondaryBias = mc_secondaryChange > 0 ? "BUY" : "SELL"

// --- SESSION STRENGTH ---
mc_currentTimeGMT = timenow
mc_currentHour = hour(mc_currentTimeGMT, "GMT+1")
mc_currentMinute = minute(mc_currentTimeGMT, "GMT+1")
mc_currentTimeMinutes = mc_currentHour * 60 + mc_currentMinute
mc_currentDayOfWeek = dayofweek(mc_currentTimeGMT, "GMT+1")

var string mc_currentSession = "OFF-HOURS"
var string mc_sessionStrength = "WEAK"
var float mc_sessionPositionSize = 50.0

if mc_currentTimeMinutes >= 0 and mc_currentTimeMinutes < 540
    mc_currentSession := "ASIA"
else if mc_currentTimeMinutes >= 540 and mc_currentTimeMinutes < 960
    mc_currentSession := "LONDON"
else if mc_currentTimeMinutes >= 960 and mc_currentTimeMinutes < 1320
    mc_currentSession := "NY"
else
    mc_currentSession := "OFF-HOURS"

if mc_currentSession == "LONDON"
    mc_sessionStrength := "PRIME"
    mc_sessionPositionSize := mc_basePositionSize * im_positionAdjustment
else if mc_currentSession == "NY"
    mc_sessionStrength := "PRIME"
    mc_sessionPositionSize := mc_basePositionSize * im_positionAdjustment
else if mc_currentSession == "ASIA"
    mc_sessionStrength := "ACCEPTABLE"
    mc_sessionPositionSize := mc_basePositionSize * 0.75 * im_positionAdjustment
else
    mc_sessionStrength := "WEAK"
    mc_sessionPositionSize := mc_basePositionSize * 0.5 * im_positionAdjustment

mc_isWeekend = mc_currentDayOfWeek == dayofweek.saturday or mc_currentDayOfWeek == dayofweek.sunday
if mc_isWeekend
    mc_currentSession := "WEEKEND"
    mc_sessionStrength := "CLOSED"
    mc_sessionPositionSize := 0.0

// ============================================================================
// SECTION 3: CORRELATION PLOTS (UNCHANGED)
// ============================================================================

plot(mc_corr_1_2, "EUR/USD ‚Üî USD/JPY", color=color.new(color.orange, 30), linewidth=2)
plot(mc_corr_1_3, "EUR/USD ‚Üî Gold", color=color.new(color.green, 30), linewidth=2)
plot(mc_corr_2_5, "USD/JPY ‚Üî Oil", color=color.new(color.blue, 30), linewidth=2)

hline(0.5, "Conflict Threshold (+)", color=color.new(color.red, 70), linestyle=hline.style_dashed)
hline(-0.5, "Conflict Threshold (-)", color=color.new(color.red, 70), linestyle=hline.style_dashed)
hline(0, "Zero Correlation", color=color.new(color.gray, 80), linestyle=hline.style_dotted)

// ============================================================================
// SECTION 4: SINGLE CONSOLIDATED TABLE
// ============================================================================
// Layout: 12 columns √ó 12 rows (optimized for width, minimal row merging)
// 
// Column Structure:
// [0-2]: Intermarket Context (VIX, S&P, DXY)
// [3-5]: Trading Focus (Primary/Secondary pairs)
// [6-7]: Session Info
// [8-9]: Current Symbol Volatility
// [10-11]: Multi-Instrument Grid + Correlations
//
// Row Structure:
// Row 0: Main header
// Row 1: Section headers
// Row 2-4: Data section 1
// Row 5-7: Data section 2
// Row 8-10: Data section 3
// Row 11: Footer / Summary
// ============================================================================

var table unifiedTable = table.new(position.top_center, 12, 12, border_width=2, border_color=color.new(color.blue, 30), frame_width=3, frame_color=color.new(color.blue, 20), force_overlay=true)

if barstate.islast
    // ========================================================================
    // ROW 0: MAIN HEADER
    // ========================================================================
    table.cell(unifiedTable, 0, 0, "FRAMEWORK 2.0 - MARKET CONTEXT DASHBOARD", text_color=color.white, bgcolor=color.new(color.blue, 10), text_size=size.normal)
    table.merge_cells(unifiedTable, 0, 0, 11, 0)
    
    // ========================================================================
    // ROW 1: SECTION HEADERS (12 columns, no merging)
    // ========================================================================
    // Columns 0-2: INTERMARKET
    table.cell(unifiedTable, 0, 1, "üåç INTERMARKET", text_color=color.white, bgcolor=im_env_color, text_size=size.small)
    table.merge_cells(unifiedTable, 0, 1, 2, 1)
    
    // Columns 3-5: TRADING FOCUS
    table.cell(unifiedTable, 3, 1, "üéØ TRADING FOCUS", text_color=color.white, bgcolor=color.new(color.green, 30), text_size=size.small)
    table.merge_cells(unifiedTable, 3, 1, 5, 1)
    
    // Columns 6-7: SESSION
    table.cell(unifiedTable, 6, 1, "‚è∞ SESSION", text_color=color.white, bgcolor=color.new(color.orange, 30), text_size=size.small)
    table.merge_cells(unifiedTable, 6, 1, 7, 1)
    
    // Columns 8-9: CURRENT SYMBOL
    table.cell(unifiedTable, 8, 1, "üìä " + syminfo.ticker, text_color=color.white, bgcolor=vr_regimeColor, text_size=size.small)
    table.merge_cells(unifiedTable, 8, 1, 9, 1)
    
    // Columns 10-11: MULTI-INSTRUMENT
    table.cell(unifiedTable, 10, 1, "üåê 5 INSTRUMENTS", text_color=color.white, bgcolor=color.new(color.purple, 30), text_size=size.small)
    table.merge_cells(unifiedTable, 10, 1, 11, 1)
    
    // ========================================================================
    // ROWS 2-4: DATA SECTION 1
    // ========================================================================
    
    // --- ROW 2: VIX / Primary Pair / Session / Current Regime / Inst1 ---
    vix_color = vix < im_vixRiskOnLevel ? color.new(color.green, 50) : vix > im_vixRiskOffLevel ? color.new(color.red, 50) : color.new(color.yellow, 50)
    table.cell(unifiedTable, 0, 2, "VIX", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 1, 2, str.tostring(vix, "#.#"), text_color=color.white, bgcolor=vix_color, text_size=size.small)
    table.cell(unifiedTable, 2, 2, vix_signal, text_color=color.white, bgcolor=vix_color, text_size=size.tiny)
    
    table.cell(unifiedTable, 3, 2, "1st", text_color=color.white, bgcolor=color.new(color.green, 50), text_size=size.small)
    table.cell(unifiedTable, 4, 2, mc_primaryPair, text_color=color.white, bgcolor=color.new(color.green, 60), text_size=size.small)
    table.cell(unifiedTable, 5, 2, mc_primaryBias + " " + str.tostring(mc_primaryChange, "#.#") + "%", text_color=color.white, bgcolor=color.new(color.green, 60), text_size=size.tiny)
    
    mc_sessionColorCell = mc_currentSession == "LONDON" or mc_currentSession == "NY" ? color.new(color.green, 50) : mc_currentSession == "ASIA" ? color.new(color.orange, 50) : color.new(color.red, 50)
    table.cell(unifiedTable, 6, 2, "Now", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 7, 2, mc_currentSession, text_color=color.white, bgcolor=mc_sessionColorCell, text_size=size.small)
    
    vr_regimeBgColor = vr_currentRegime == "HIGH" ? color.new(color.red, 50) : vr_currentRegime == "LOW" ? color.new(color.yellow, 50) : color.new(color.green, 50)
    table.cell(unifiedTable, 8, 2, "Regime", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 9, 2, vr_currentRegime + " [" + str.tostring(vr_atrPercentile, "#") + "%]", text_color=color.white, bgcolor=vr_regimeBgColor, text_size=size.small)
    
    vr_regime1Color = vr_regime1 == "HIGH" ? color.new(color.red, 50) : vr_regime1 == "LOW" ? color.new(color.yellow, 50) : color.new(color.green, 50)
    vr_regime1Icon = vr_regime1 == "HIGH" ? "üî¥" : vr_regime1 == "LOW" ? "üü°" : "üü¢"
    table.cell(unifiedTable, 10, 2, "EUR", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 11, 2, vr_regime1Icon + " " + str.tostring(vr_posSize1, "#") + "‚Ç¨", text_color=color.white, bgcolor=vr_regime1Color, text_size=size.small)
    
    // --- ROW 3: S&P / Secondary Pair / Size / Current Size / Inst2 ---
    sp500_color = sp500 > sp500_ma20 ? color.new(color.green, 50) : color.new(color.red, 50)
    table.cell(unifiedTable, 0, 3, "S&P", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 1, 3, sp500_signal, text_color=color.white, bgcolor=sp500_color, text_size=size.small)
    table.cell(unifiedTable, 2, 3, sp500 > sp500_ma20 ? "‚úÖ" : "‚ùå", text_color=color.white, bgcolor=sp500_color, text_size=size.small)
    
    table.cell(unifiedTable, 3, 3, "2nd", text_color=color.white, bgcolor=color.new(color.orange, 50), text_size=size.small)
    table.cell(unifiedTable, 4, 3, mc_secondaryPair, text_color=color.white, bgcolor=color.new(color.orange, 60), text_size=size.small)
    table.cell(unifiedTable, 5, 3, mc_secondaryBias + " " + str.tostring(mc_secondaryChange, "#.#") + "%", text_color=color.white, bgcolor=color.new(color.orange, 60), text_size=size.tiny)
    
    table.cell(unifiedTable, 6, 3, "Size", text_color=color.white, bgcolor=color.new(color.blue, 50), text_size=size.small)
    table.cell(unifiedTable, 7, 3, str.tostring(mc_sessionPositionSize, "#") + " EUR", text_color=color.yellow, bgcolor=color.new(color.blue, 60), text_size=size.small)
    
    vr_positionBgColor = vr_positionSize < 100 ? color.new(color.red, 50) : color.new(color.green, 50)
    table.cell(unifiedTable, 8, 3, "Size", text_color=color.white, bgcolor=color.new(color.blue, 50), text_size=size.small)
    table.cell(unifiedTable, 9, 3, str.tostring(vr_positionSize, "#") + " EUR", text_color=color.yellow, bgcolor=vr_positionBgColor, text_size=size.small)
    
    vr_regime2Color = vr_regime2 == "HIGH" ? color.new(color.red, 50) : vr_regime2 == "LOW" ? color.new(color.yellow, 50) : color.new(color.green, 50)
    vr_regime2Icon = vr_regime2 == "HIGH" ? "üî¥" : vr_regime2 == "LOW" ? "üü°" : "üü¢"
    table.cell(unifiedTable, 10, 3, "JPY", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 11, 3, vr_regime2Icon + " " + str.tostring(vr_posSize2, "#") + "‚Ç¨", text_color=color.white, bgcolor=vr_regime2Color, text_size=size.small)
    
    // --- ROW 4: DXY / (skip) / Reason / Adjustments / Inst3 ---
    dxy_color = dxy < dxy_ma50 ? color.new(color.green, 50) : color.new(color.red, 50)
    table.cell(unifiedTable, 0, 4, "DXY", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 1, 4, str.tostring(dxy, "#.#"), text_color=color.white, bgcolor=dxy_color, text_size=size.small)
    table.cell(unifiedTable, 2, 4, dxy_signal, text_color=color.white, bgcolor=dxy_color, text_size=size.tiny)
    
    table.cell(unifiedTable, 3, 4, "", bgcolor=color.new(color.gray, 95), text_size=size.tiny)
    table.merge_cells(unifiedTable, 3, 4, 5, 4)
    
    table.cell(unifiedTable, 6, 4, im_adjustmentText, text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)
    table.merge_cells(unifiedTable, 6, 4, 7, 4)
    
    table.cell(unifiedTable, 8, 4, "Stop", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 9, 4, str.tostring(vr_stopMultiplier, "#.#") + "√óATR", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    
    vr_regime3Color = vr_regime3 == "HIGH" ? color.new(color.red, 50) : vr_regime3 == "LOW" ? color.new(color.yellow, 50) : color.new(color.green, 50)
    vr_regime3Icon = vr_regime3 == "HIGH" ? "üî¥" : vr_regime3 == "LOW" ? "üü°" : "üü¢"
    table.cell(unifiedTable, 10, 4, "XAU", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 11, 4, vr_regime3Icon + " " + str.tostring(vr_posSize3, "#") + "‚Ç¨", text_color=color.white, bgcolor=vr_regime3Color, text_size=size.small)
    
    // ========================================================================
    // ROWS 5-7: DATA SECTION 2 (Environment, Targets, More Instruments)
    // ========================================================================
    
    // --- ROW 5: Environment / (skip) / (skip) / Target / Inst4 ---
    table.cell(unifiedTable, 0, 5, "ENV", text_color=color.white, bgcolor=color.new(color.blue, 50), text_size=size.small)
    table.cell(unifiedTable, 1, 5, im_environment, text_color=color.white, bgcolor=im_env_color, text_size=size.small)
    table.merge_cells(unifiedTable, 1, 5, 2, 5)
    
    table.cell(unifiedTable, 3, 5, "", bgcolor=color.new(color.gray, 95))
    table.merge_cells(unifiedTable, 3, 5, 7, 5)
    
    table.cell(unifiedTable, 8, 5, "Target", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 9, 5, vr_targetRMultiple, text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    
    vr_regime4Color = vr_regime4 == "HIGH" ? color.new(color.red, 50) : vr_regime4 == "LOW" ? color.new(color.yellow, 50) : color.new(color.green, 50)
    vr_regime4Icon = vr_regime4 == "HIGH" ? "üî¥" : vr_regime4 == "LOW" ? "üü°" : "üü¢"
    table.cell(unifiedTable, 10, 5, "XAG", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 11, 5, vr_regime4Icon + " " + str.tostring(vr_posSize4, "#") + "‚Ç¨", text_color=color.white, bgcolor=vr_regime4Color, text_size=size.small)
    
    // --- ROW 6: (skip) / (skip) / (skip) / Entry / Inst5 ---
    table.cell(unifiedTable, 0, 6, "", bgcolor=color.new(color.gray, 95))
    table.merge_cells(unifiedTable, 0, 6, 7, 6)
    
    table.cell(unifiedTable, 8, 6, "Entry", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 9, 6, vr_entryZone, text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    
    vr_regime5Color = vr_regime5 == "HIGH" ? color.new(color.red, 50) : vr_regime5 == "LOW" ? color.new(color.yellow, 50) : color.new(color.green, 50)
    vr_regime5Icon = vr_regime5 == "HIGH" ? "üî¥" : vr_regime5 == "LOW" ? "üü°" : "üü¢"
    table.cell(unifiedTable, 10, 6, "OIL", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    table.cell(unifiedTable, 11, 6, vr_regime5Icon + " " + str.tostring(vr_posSize5, "#") + "‚Ç¨", text_color=color.white, bgcolor=vr_regime5Color, text_size=size.small)
    
    // --- ROW 7: Separator ---
    table.cell(unifiedTable, 0, 7, "", bgcolor=color.new(color.gray, 90), height=2)
    table.merge_cells(unifiedTable, 0, 7, 11, 7)
    
    // ========================================================================
    // ROWS 8-10: CORRELATION CONFLICTS SECTION
    // ========================================================================
    
    // --- ROW 8: Correlation Header ---
    table.cell(unifiedTable, 0, 8, "‚ö†Ô∏è CORRELATION CONFLICTS", text_color=color.white, bgcolor=color.new(color.red, 20), text_size=size.small)
    table.merge_cells(unifiedTable, 0, 8, 11, 8)
    
    // --- ROW 9: Correlation Column Headers ---
    table.cell(unifiedTable, 0, 9, "EUR‚ÜîJPY", text_color=color.white, bgcolor=color.new(color.gray, 60), text_size=size.small)
    table.cell(unifiedTable, 1, 9, str.tostring(mc_corr_1_2, "#.##"), text_color=color.white, bgcolor=math.abs(mc_corr_1_2) >= mc_correlationThreshold ? color.new(color.red, 50) : color.new(color.green, 50), text_size=size.small)
    table.cell(unifiedTable, 2, 9, math.abs(mc_corr_1_2) >= mc_correlationThreshold ? "üî¥ 50" : "üü¢ Safe", text_color=color.white, bgcolor=math.abs(mc_corr_1_2) >= mc_correlationThreshold ? color.new(color.red, 50) : color.new(color.green, 50), text_size=size.tiny)
    
    table.cell(unifiedTable, 3, 9, "EUR‚ÜîXAU", text_color=color.white, bgcolor=color.new(color.gray, 60), text_size=size.small)
    table.cell(unifiedTable, 4, 9, str.tostring(mc_corr_1_3, "#.##"), text_color=color.white, bgcolor=math.abs(mc_corr_1_3) >= mc_correlationThreshold ? color.new(color.red, 50) : color.new(color.green, 50), text_size=size.small)
    table.cell(unifiedTable, 5, 9, math.abs(mc_corr_1_3) >= mc_correlationThreshold ? "üî¥ 50" : "üü¢ Safe", text_color=color.white, bgcolor=math.abs(mc_corr_1_3) >= mc_correlationThreshold ? color.new(color.red, 50) : color.new(color.green, 50), text_size=size.tiny)
    
    table.cell(unifiedTable, 6, 9, "EUR‚ÜîXAG", text_color=color.white, bgcolor=color.new(color.gray, 60), text_size=size.small)
    table.cell(unifiedTable, 7, 9, str.tostring(mc_corr_1_4, "#.##"), text_color=color.white, bgcolor=math.abs(mc_corr_1_4) >= mc_correlationThreshold ? color.new(color.red, 50) : color.new(color.green, 50), text_size=size.small)
    
    table.cell(unifiedTable, 8, 9, "JPY‚ÜîOIL", text_color=color.white, bgcolor=color.new(color.gray, 60), text_size=size.small)
    table.cell(unifiedTable, 9, 9, str.tostring(mc_corr_2_5, "#.##"), text_color=color.white, bgcolor=math.abs(mc_corr_2_5) >= mc_correlationThreshold ? color.new(color.red, 50) : color.new(color.green, 50), text_size=size.small)
    
    table.cell(unifiedTable, 10, 9, "XAU‚ÜîXAG", text_color=color.white, bgcolor=color.new(color.gray, 60), text_size=size.small)
    table.cell(unifiedTable, 11, 9, str.tostring(mc_corr_3_4, "#.##"), text_color=color.white, bgcolor=math.abs(mc_corr_3_4) >= mc_correlationThreshold ? color.new(color.red, 50) : color.new(color.green, 50), text_size=size.small)
    
    // --- ROW 10: Correlation Footer ---
    table.cell(unifiedTable, 0, 10, "20-day rolling correlation | Threshold: ¬±" + str.tostring(mc_correlationThreshold, "#.##"), text_color=color.yellow, bgcolor=color.new(color.gray, 80), text_size=size.tiny)
    table.merge_cells(unifiedTable, 0, 10, 11, 10)
    
    // ========================================================================
    // ROW 11: FOOTER / SUMMARY
    // ========================================================================
    vr_reasonText = ""
    if vr_currentRegime == "HIGH" and im_environment == "RISK-OFF"
        vr_reasonText := "‚ö†Ô∏è HIGH VOL + RISK-OFF: Both adjustments active"
    else if vr_currentRegime == "HIGH"
        vr_reasonText := "‚ö†Ô∏è HIGH VOLATILITY: 50% position reduction"
    else if im_environment == "RISK-OFF"
        vr_reasonText := "‚ö†Ô∏è RISK-OFF: 75% position sizing"
    else if vix > im_extremeVixLevel
        vr_reasonText := "üö® VIX EXTREME (>30): 50% position reduction"
    else if vr_currentRegime == "LOW"
        vr_reasonText := "‚ÑπÔ∏è LOW VOLATILITY: Lower targets (1.3R)"
    else
        vr_reasonText := "‚úÖ NORMAL CONDITIONS: Standard position sizing (100 EUR)"
    
    table.cell(unifiedTable, 0, 11, vr_reasonText, text_color=color.white, bgcolor=color.new(color.blue, 50), text_size=size.small)
    table.merge_cells(unifiedTable, 0, 11, 11, 11)

// ============================================================================
// SECTION 5: ALERTS (UNCHANGED)
// ============================================================================

vr_regimeChanged = vr_currentRegime != vr_currentRegime[1]
vr_highRegimeEntered = vr_currentRegime == "HIGH" and vr_currentRegime[1] != "HIGH"
im_extremeVix = vix > im_extremeVixLevel
im_riskOffEnvironment = im_environment == "RISK-OFF" and im_environment[1] != "RISK-OFF"

if vr_regimeChanged
    alert("Volatility regime changed to " + vr_currentRegime, alert.freq_once_per_bar)

if vr_highRegimeEntered
    alert("‚ö†Ô∏è HIGH volatility regime detected - MANDATORY position reduction to 50 EUR!", alert.freq_once_per_bar)

if im_extremeVix
    alert("‚ö†Ô∏è VIX EXTREME (>30) - Consider 50 EUR positions or no trading!", alert.freq_once_per_bar)

if im_riskOffEnvironment
    alert("‚ö†Ô∏è RISK-OFF environment detected - Adjust position sizes!", alert.freq_once_per_bar)

mc_highCorrelationDetected = math.abs(mc_corr_1_2) >= mc_correlationThreshold or math.abs(mc_corr_1_3) >= mc_correlationThreshold or math.abs(mc_corr_2_5) >= mc_correlationThreshold

alertcondition(vr_regimeChanged, title="Volatility Regime Changed", message="Volatility regime has changed - check indicator")
alertcondition(vr_highRegimeEntered, title="HIGH Volatility Regime", message="HIGH volatility - reduce to 50 EUR")
alertcondition(im_extremeVix, title="VIX Extreme Level", message="VIX > 30 - Consider 50 EUR or no trading")
alertcondition(im_riskOffEnvironment, title="Risk-Off Environment", message="Risk-off detected - adjust positions")
alertcondition(mc_highCorrelationDetected, title="Correlation Conflict", message="High correlation - check sizing!")

// ============================================================================
// END OF SINGLE TABLE VERSION v4.0
// 12 COLUMNS √ó 12 ROWS - OPTIMIZED LAYOUT
// ============================================================================