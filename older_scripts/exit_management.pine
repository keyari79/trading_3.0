//@version=6
indicator("Exit - Management Dashboard - v5.0 OPTIMIZED", shorttitle="EXIT-MGR-v5", overlay=true)

// ============================================================================
// CTA OPTIMIZATION v5.0 - November 2025
// Addresses all gaps from Stage 6 CTA Quality Check
// ============================================================================

// ===== INPUTS =====
showDashboard = input.bool(true, "Show Exit Dashboard", group="Display")
positionActive = input.bool(true, "Position Active", group="Position")
isLong = input.bool(true, "Long Position", group="Position")
entryPrice = input.float(1.05000, "Entry Price", group="Position")
targetPrice = input.float(1.05750, "Target Price", group="Position")
stopPrice = input.float(1.04500, "Stop Loss Price", group="Position")
riskAmount = input.float(100.0, "Risk Amount (EUR)", group="Position")

// Regime inputs
regime = input.string("NORMAL", "Volatility Regime", options=["LOW", "NORMAL", "HIGH"], group="Context")
sessionStrength = input.string("PRIME", "Session Strength", options=["PRIME", "ACCEPTABLE", "WEAK"], group="Context")

// Daily risk tracking
dailyPnL = input.float(0.0, "Current Daily P&L (EUR)", group="Risk")
dailyLimit = input.float(-300.0, "Daily Loss Limit (EUR)", group="Risk")

// Entry time (for elapsed time calculation)
entryHour = input.int(9, "Entry Hour", minval=0, maxval=23, group="Time")
entryMinute = input.int(30, "Entry Minute", minval=0, maxval=59, group="Time")

// Emergency trigger overrides
structureOverride = input.bool(false, "Structure Break", group="Emergency Overrides")
patternOverride = input.bool(false, "Pattern Failure", group="Emergency Overrides")
newsOverride = input.bool(false, "News Event", group="Emergency Overrides")
technicalOverride = input.bool(false, "Technical Breakdown", group="Emergency Overrides")

// ===== CALCULATIONS =====

// Current time calculations
currentHour = hour(time, "CET")
currentMinute = minute(time, "CET")
entryTimeMinutes = entryHour * 60 + entryMinute
currentTimeMinutes = currentHour * 60 + currentMinute
minutesElapsed = currentTimeMinutes >= entryTimeMinutes ? currentTimeMinutes - entryTimeMinutes : (24 * 60 - entryTimeMinutes) + currentTimeMinutes
secondsInMinute = second(time)
timeRemaining = 60 - minutesElapsed

// Time status with progressive warnings
timeStatus = minutesElapsed >= 58 ? "ðŸ”´ EXIT NOW" : minutesElapsed >= 55 ? "âš ï¸ 5 MIN LEFT" : minutesElapsed >= 50 ? "âš ï¸ 10 MIN LEFT" : minutesElapsed >= 45 ? "â° 15 MIN LEFT" : "ðŸŸ¢ TIME OK"
timeColor = minutesElapsed >= 55 ? color.new(color.red, 0) : minutesElapsed >= 50 ? color.new(color.orange, 0) : minutesElapsed >= 45 ? color.new(color.yellow, 0) : color.new(color.lime, 0)

// P&L calculations
currentPrice = close
priceDiff = isLong ? (currentPrice - entryPrice) : (entryPrice - currentPrice)
stopDiff = isLong ? (entryPrice - stopPrice) : (stopPrice - entryPrice)
targetDiff = isLong ? (targetPrice - entryPrice) : (entryPrice - targetPrice)

// R calculations
currentR = stopDiff != 0 ? priceDiff / stopDiff : 0
targetR = stopDiff != 0 ? targetDiff / stopDiff : 0
maxRSeen = ta.highest(currentR, 60)  // Track peak R in last 60 bars

// Actual P&L
currentPnL = currentR * riskAmount
maxPnLSeen = maxRSeen * riskAmount

// Target achievement
targetDistance = isLong ? (targetPrice - currentPrice) : (currentPrice - targetPrice)
targetDistancePips = targetDistance / syminfo.mintick
distanceToTarget = math.abs(targetDistancePips)
atTarget = distanceToTarget <= 3  // Within 3 pips

// Emergency checks
structureOK = not structureOverride
patternOK = not patternOverride
newsOK = not newsOverride
technicalOK = not technicalOverride
riskLimitOK = dailyPnL > dailyLimit + 50  // Safe if more than 50 EUR from limit

emergencyActive = not structureOK or not patternOK or not newsOK or not technicalOK or not riskLimitOK

// Emergency reason (specific, not generic)
emergencyReason = not structureOK ? "STRUCTURE BREAK" : not patternOK ? "PATTERN FAIL" : not newsOK ? "NEWS EVENT" : not technicalOK ? "TECHNICAL FAIL" : not riskLimitOK ? "RISK LIMIT" : "REVIEW"

// Status determination (FORCE EXIT takes priority)
statusText = emergencyActive ? "ðŸ”´ FORCE EXIT" : atTarget ? "ðŸŽ¯ TARGET" : minutesElapsed >= 58 ? "â° TIME EXIT" : "ðŸŸ¢ ACTIVE"
statusColor = emergencyActive ? color.new(color.red, 0) : atTarget ? color.new(color.lime, 0) : minutesElapsed >= 55 ? color.new(color.orange, 0) : color.new(color.lime, 0)

// Risk buffer calculations (NEW - Gap 6)
riskBuffer = dailyLimit + dailyPnL  // EUR remaining to daily limit
riskBufferR = riskBuffer / riskAmount  // R remaining to daily limit
riskStatus = riskBuffer >= -100 ? "ðŸ”´ CRITICAL" : riskBuffer >= -150 ? "âš ï¸ WARNING" : "âœ… SAFE"
riskStatusColor = riskBuffer >= -100 ? color.new(color.red, 0) : riskBuffer >= -150 ? color.new(color.orange, 0) : color.new(color.lime, 0)

// Emergency status rows (more specific)
emergencyRows = array.new_string(0)
emergencyColors = array.new_color(0)

if not structureOK
    array.push(emergencyRows, "ðŸ—ï¸ Structure")
    array.push(emergencyColors, color.new(color.red, 0))
if not patternOK
    array.push(emergencyRows, "ðŸ“Š Pattern")
    array.push(emergencyColors, color.new(color.red, 0))
if not newsOK
    array.push(emergencyRows, "ðŸ“° News")
    array.push(emergencyColors, color.new(color.red, 0))
if not technicalOK
    array.push(emergencyRows, "âš™ï¸ Technical")
    array.push(emergencyColors, color.new(color.red, 0))
if not riskLimitOK
    array.push(emergencyRows, "ðŸ’° Risk Limit")
    array.push(emergencyColors, color.new(color.red, 0))

if array.size(emergencyRows) == 0
    array.push(emergencyRows, "ðŸ—ï¸ Structure")
    array.push(emergencyColors, color.new(color.lime, 0))
    array.push(emergencyRows, "ðŸ“Š Pattern")
    array.push(emergencyColors, color.new(color.lime, 0))
    array.push(emergencyRows, "ðŸ“° News")
    array.push(emergencyColors, color.new(color.lime, 0))
    array.push(emergencyRows, "ðŸ’° Risk Limit")
    array.push(emergencyColors, color.new(color.lime, 0))
    array.push(emergencyRows, "âš™ï¸ Technical")
    array.push(emergencyColors, color.new(color.lime, 0))

// Guidance text (regime-specific and dynamic - Gap 5)
guidance = minutesElapsed >= 58 ? "â° EXIT IMMEDIATELY - Time Limit" : emergencyActive ? "ðŸš¨ " + emergencyReason + " - Exit Now" : atTarget ? "âœ“ TARGET HIT - Exit Now" : currentR >= 1.0 and regime == "HIGH" and minutesElapsed >= 40 ? "Consider exit at 1.0R+ (HIGH regime + time)" : currentR >= 1.0 and minutesElapsed >= 50 ? "Consider exit at 1.0R+ (time pressure)" : currentR >= 1.0 and regime == "LOW" ? "Consider exit at 1.0R+ (LOW regime)" : currentR >= targetR * 0.9 ? "Near target - hold for full " + str.tostring(targetR, "#.#") + "R" : "Hold for full " + str.tostring(targetR, "#.#") + "R target"

// ===== DASHBOARD TABLE =====
var table posTable = na

if positionActive and showDashboard and barstate.islast
    // Delete old table
    if not na(posTable)
        table.delete(posTable)
    
    // Create new table (expanded for stop loss and risk buffer)
    posTable := table.new(position.top_right, 2, 14, border_width=2, border_color=color.new(color.gray, 50), frame_color=color.new(color.gray, 70), frame_width=1)
    
    // === HEADER ===
    table.cell(posTable, 0, 0, "EXIT MANAGEMENT", text_color=color.new(color.yellow, 0), text_size=size.normal, bgcolor=color.new(color.gray, 80))
    table.cell(posTable, 1, 0, isLong ? "LONG" : "SHORT", text_color=isLong ? color.new(color.lime, 0) : color.new(color.red, 0), text_size=size.normal, bgcolor=color.new(color.gray, 80))
    
    // === TIME IN TRADE (Row 1) ===
    table.cell(posTable, 0, 1, "â±ï¸ TIME IN TRADE", text_color=color.new(color.white, 0), text_size=size.small, bgcolor=color.new(color.gray, 90))
    timeDisplay = str.tostring(minutesElapsed) + "m:" + str.format("{0,number,00}", secondsInMinute) + "s / 60m"
    table.cell(posTable, 1, 1, timeDisplay, text_color=timeColor, text_size=size.normal, bgcolor=color.new(color.gray, 90))
    
    // === STATUS (Row 2) ===
    table.cell(posTable, 0, 2, "STATUS", text_color=color.new(color.white, 0), text_size=size.small, bgcolor=color.new(color.gray, 90))
    table.cell(posTable, 1, 2, statusText, text_color=statusColor, text_size=size.large, bgcolor=color.new(color.gray, 90))
    
    // === CURRENT P&L - ENHANCED (Row 3) ===
    table.cell(posTable, 0, 3, "ðŸ’° CURRENT P&L", text_color=color.new(color.white, 0), text_size=size.small, bgcolor=color.new(color.gray, 90))
    pnlColor = currentPnL >= 0 ? color.new(color.lime, 0) : color.new(color.red, 0)
    pnlText = (currentPnL >= 0 ? "+" : "") + str.tostring(currentPnL, "#.##") + " EUR"
    table.cell(posTable, 1, 3, pnlText, text_color=pnlColor, text_size=size.large, bgcolor=color.new(color.gray, 90))
    
    // === CURRENT R (Row 4) ===
    table.cell(posTable, 0, 4, "ðŸ“Š CURRENT R", text_color=color.new(color.white, 0), text_size=size.small, bgcolor=color.new(color.gray, 90))
    rColor = currentR >= targetR ? color.new(color.lime, 0) : currentR >= 0 ? color.new(color.yellow, 0) : color.new(color.red, 0)
    rText = str.tostring(currentR, "#.##") + "R"
    rIndicator = atTarget ? " | ðŸŽ¯ TARGET" : ""
    table.cell(posTable, 1, 4, rText + rIndicator, text_color=rColor, text_size=size.normal, bgcolor=color.new(color.gray, 90))
    
    // === MAX R SEEN (Row 5) ===
    table.cell(posTable, 0, 5, "ðŸ’Ž MAX R SEEN", text_color=color.new(color.white, 0), text_size=size.small, bgcolor=color.new(color.gray, 90))
    table.cell(posTable, 1, 5, str.tostring(maxRSeen, "#.##") + "R", text_color=color.new(color.aqua, 0), text_size=size.normal, bgcolor=color.new(color.gray, 90))
    
    // === TARGET PRICE (Row 6) ===
    table.cell(posTable, 0, 6, "ðŸŽ¯ TARGET PRICE", text_color=color.new(color.white, 0), text_size=size.small, bgcolor=color.new(color.gray, 90))
    targetText = str.tostring(targetPrice, format.mintick) + " (" + str.tostring(targetR, "#.#") + "R)"
    table.cell(posTable, 1, 6, targetText, text_color=color.new(color.lime, 0), text_size=size.normal, bgcolor=color.new(color.gray, 90))
    
    // === STOP LOSS - NEW (Row 7) ===
    table.cell(posTable, 0, 7, "ðŸ›‘ STOP LOSS", text_color=color.new(color.white, 0), text_size=size.small, bgcolor=color.new(color.gray, 90))
    stopText = str.tostring(stopPrice, format.mintick)
    stopDistance = isLong ? currentPrice - stopPrice : stopPrice - currentPrice
    stopPips = math.abs(stopDistance) * 10000  // Convert to pips for forex (4 decimal places)
    stopInfo = stopText + " (" + str.tostring(stopPips, "#.#") + " pips away)"
    table.cell(posTable, 1, 7, stopInfo, text_color=color.new(color.red, 0), text_size=size.normal, bgcolor=color.new(color.gray, 90))
    
    // === EMERGENCY STATUS - ENHANCED (Row 8) ===
    table.cell(posTable, 0, 8, "ðŸš¨ EMERGENCY", text_color=color.new(color.white, 0), text_size=size.small, bgcolor=color.new(color.gray, 90))
    emergencyText = emergencyActive ? "âš ï¸ " + emergencyReason : "âœ… NONE"
    emergencyColor = emergencyActive ? color.new(color.red, 0) : color.new(color.lime, 0)
    table.cell(posTable, 1, 8, emergencyText, text_color=emergencyColor, text_size=size.normal, bgcolor=color.new(color.gray, 90))
    
    // === EMERGENCY CHECKLIST (Rows 9-10) - More specific ===
    for i = 0 to math.min(array.size(emergencyRows) - 1, 4)
        rowLabel = array.get(emergencyRows, i)
        rowColor = array.get(emergencyColors, i)
        rowStatus = str.contains(rowLabel, "Structure") ? (structureOK ? "âœ… OK" : "âŒ FAIL") : str.contains(rowLabel, "Pattern") ? (patternOK ? "âœ… OK" : "âŒ FAIL") : str.contains(rowLabel, "News") ? (newsOK ? "âœ… OK" : "âŒ FAIL") : str.contains(rowLabel, "Risk") ? (riskLimitOK ? "âœ… OK" : "âŒ FAIL") : (technicalOK ? "âœ… OK" : "âŒ FAIL")
        table.cell(posTable, 0, 9 + i, rowLabel, text_color=color.new(color.white, 0), text_size=size.small, bgcolor=color.new(color.gray, 95))
        table.cell(posTable, 1, 9 + i, rowStatus, text_color=rowColor, text_size=size.small, bgcolor=color.new(color.gray, 95))
    
    // === RISK BUFFER - NEW (Row 11) ===
    table.cell(posTable, 0, 11, "ðŸ’° RISK BUFFER", text_color=color.new(color.white, 0), text_size=size.normal, bgcolor=color.new(color.gray, 90))
    bufferText = str.tostring(math.abs(riskBuffer), "#.#") + " EUR (" + str.tostring(math.abs(riskBufferR), "#.#") + "R) to limit"
    table.cell(posTable, 1, 11, riskStatus + " | " + bufferText, text_color=riskStatusColor, text_size=size.normal, bgcolor=color.new(color.gray, 90))
    
    // === GUIDANCE - ENHANCED (Row 12) ===
    table.cell(posTable, 0, 12, "ðŸ’¡ GUIDANCE", text_color=color.new(color.white, 0), text_size=size.small, bgcolor=color.new(color.gray, 90))
    guidanceColor = str.contains(guidance, "EXIT") or str.contains(guidance, "Exit") ? color.new(color.red, 0) : str.contains(guidance, "Consider") ? color.new(color.yellow, 0) : color.new(color.white, 0)
    table.cell(posTable, 1, 12, guidance, text_color=guidanceColor, text_size=size.small, bgcolor=color.new(color.gray, 90))
    
    // === REGIME ROW (Row 13) ===
    table.cell(posTable, 0, 13, "REGIME", text_color=color.new(color.gray, 0), text_size=size.small, bgcolor=color.new(color.gray, 95))
    regimeDisplay = regime + " | " + sessionStrength
    table.cell(posTable, 1, 13, regimeDisplay, text_color=color.new(color.gray, 0), text_size=size.small, bgcolor=color.new(color.gray, 95))

// ===== VISUAL MARKERS =====

// Plot stop loss line
stopLine = positionActive ? stopPrice : na
plot(stopLine, "Stop Loss", color=color.new(color.red, 0), linewidth=2, style=plot.style_linebr)

// Plot target line  
targetLine = positionActive ? targetPrice : na
plot(targetLine, "Target", color=color.new(color.lime, 0), linewidth=2, style=plot.style_linebr)

// Plot entry line
entryLine = positionActive ? entryPrice : na
plot(entryLine, "Entry", color=color.new(color.yellow, 50), linewidth=1, style=plot.style_linebr)

// ===== ALERTS =====

// Target hit alert
alertcondition(atTarget and positionActive, title="ðŸŽ¯ Target Hit", message="EXIT: Target reached")

// Time limit warning
alertcondition(minutesElapsed >= 55 and positionActive, title="â° Time Warning", message="EXIT SOON: 5 minutes remaining in trade")

// Emergency exit alert
alertcondition(emergencyActive and positionActive, title="ðŸš¨ Emergency Exit", message="FORCE EXIT: Emergency trigger active - Exit immediately")

// Risk buffer warning
alertcondition(riskBuffer >= -150 and riskBuffer < -100 and positionActive, title="âš ï¸ Risk Buffer Warning", message="WARNING: Approaching daily limit")

// Risk buffer critical
alertcondition(riskBuffer >= -100 and positionActive, title="ðŸ”´ Risk Buffer Critical", message="CRITICAL: Near daily limit - Consider exit")

// ===== CHANGE LOG =====
// v5.0 - November 2025 - CTA Optimization
// - Added stop loss price display (Gap 1)
// - Enhanced P&L display with larger font and clear +/- (Gap 2)
// - Specific emergency reasons instead of generic "REVIEW" (Gap 3)
// - Progressive time warnings at 45/50/55 minutes (Gap 4)
// - Regime-specific and dynamic guidance text (Gap 5)
// - Added risk buffer monitoring with daily limit distance (Gap 6)
// - All ternary operators kept on single lines (PineScript v6 compliance)
// - Optimized for CTA screenshot analysis